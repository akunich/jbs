<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Params');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(!IsSet($Params['TypeID']))
	$Params['TypeID'] = 'Hosting';
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$ExecuteDate = Time();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Array = Array('Delete','Suspend','Active','Create');
#-------------------------------------------------------------------------------
$Types = Array();
#-------------------------------------------------------------------------------
foreach($Array as $Type)
	$Types[] = SPrintF("`TypeID` = '%s%s'",$Params['TypeID'],$Type);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Where = Array(
		Implode(' OR ',$Types),
		"`IsExecuted` = 'no'"
		);
#-------------------------------------------------------------------------------
$TaskExecuteTime = DB_Select('Tasks','ExecuteDate',Array('UNIQ','Where'=>$Where,'SortOn'=>'ExecuteDate','IsDesc'=>TRUE,'Limits'=>Array(0,1)));
#-------------------------------------------------------------------------------
switch(ValueOf($TaskExecuteTime)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	break;
case 'array':
	#-------------------------------------------------------------------------------
	# если не более двух часов в будущем - ставим +2 минуты
	if($TaskExecuteTime['ExecuteDate'] < Time() + 2*3600)
		$ExecuteDate = $TaskExecuteTime['ExecuteDate'] + 2*60;
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $ExecuteDate;
#-------------------------------------------------------------------------------

?>
