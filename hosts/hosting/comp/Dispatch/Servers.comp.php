<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('IsSearch');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Orders = DB_Select('OrdersOwners',Array('ID','UserID','StatusID','(SELECT `Address` FROM `Servers` WHERE `Servers`.`ID` = `OrdersOwners`.`ServerID`) AS `Address`'),Array('SortOn'=>Array('ServiceID','Address')));
#-------------------------------------------------------------------------------
switch(ValueOf($Orders)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return FALSE;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Filters = Array('Name'=>'Сервера + Статусы');
#-------------------------------------------------------------------------------
foreach($Orders as $Order){
	#-------------------------------------------------------------------------------
	if(Is_Null($Order['Address']))
		continue;
	#-------------------------------------------------------------------------------
	# добавляем сервера к списку фильтров
	if(!IsSet($Filters[$Order['Address']]))
		$Filters[$Order['Address']] = Array('Name'=>$Order['Address'],'UsersIDs'=>Array());
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
$Filters['Delimiter'] = '+ + +';
#-------------------------------------------------------------------------------
# get config values
$Config = Config();
#-------------------------------------------------------------------------------
$Statuses = $Config['Statuses']['DomainOrders'];
#-------------------------------------------------------------------------------
# обавляем статусы к списку фильтров
foreach($Orders as $Order)
	if(!IsSet($Filters[$Order['StatusID']]))
		$Filters[$Order['StatusID']] = Array('Name'=>IsSet($Statuses[$Order['StatusID']])?$Statuses[$Order['StatusID']]['Name']:$Order['StatusID'],'UsersIDs'=>Array());
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Array = Array();
#-------------------------------------------------------------------------------
if($IsSearch){
	#-------------------------------------------------------------------------------
	#Debug(SPrintF('[comp/Dispatch/Servers]: IsSearch = %s',print_r($IsSearch,true)));
	#-------------------------------------------------------------------------------
	foreach($Orders as $Order)
		if(In_Array($Order['Address'],$IsSearch))
			if(In_Array($Order['StatusID'],$IsSearch))
				$Array[] = $Order['UserID'];
	#-------------------------------------------------------------------------------
	$Array = Array_Unique($Array);
	#-------------------------------------------------------------------------------
	#Debug(SPrintF('[comp/Dispatch/Servers]: Array = %s',Implode(',',$Array)));
	#-------------------------------------------------------------------------------
	$Filters['UsersIDs'] = $Array;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Filters;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
