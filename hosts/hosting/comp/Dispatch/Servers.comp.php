<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('IsSearch');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Servers = DB_Select('Servers',Array('ID','Address'),Array('SortOn'=>Array('ServersGroupID','Address')));
#-------------------------------------------------------------------------------
switch(ValueOf($Servers)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return FALSE;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Filters = Array('Сервера размещения');
#-------------------------------------------------------------------------------
foreach($Servers as $Server){
	#-------------------------------------------------------------------------------
	$Filter = Array('Name'=>$Server['Address'],'UsersIDs'=>Array());
	#-------------------------------------------------------------------------------
	if($IsSearch){
		#-------------------------------------------------------------------------------
		$Orders = DB_Select('OrdersOwners','UserID',Array('Where'=>SPrintF('`ServerID` = %u',$Server['ID'])));
		#-------------------------------------------------------------------------------
		switch(ValueOf($Orders)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			# No more...
			break;
		case 'array':
			#-------------------------------------------------------------------------------
			$UsersIDs = Array();
			#-------------------------------------------------------------------------------
			foreach($Orders as $Order)
				$UsersIDs[] = $Order['UserID'];
			#-------------------------------------------------------------------------------
			$UsersIDs = Array_Unique($UsersIDs);
			#-------------------------------------------------------------------------------
			$Filter['UsersIDs'] = $UsersIDs;
			#-------------------------------------------------------------------------------
			break;
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Filters[$Server['Address']] = $Filter;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Filters;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
