<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru  */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$ServerID	= (integer) @$Args['ServerID'];
$TemplateID	=  (string) @$Args['TemplateID'];
$Window		=  (string) @$Args['Window'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
if($ServerID){
	#-------------------------------------------------------------------------------
	$Server = DB_Select('Servers',Array('ID','ServiceID','(SELECT `Code` FROM `Services` WHERE `Services`.`ID` = `ServiceID`) as `Code`','Params'),Array('UNIQ','ID'=>$ServerID));
	#-------------------------------------------------------------------------------
	switch(ValueOf($Server)){
	case 'error':
		return ERROR | @Trigger_Error(500);
	case 'exception':
		return ERROR | @Trigger_Error(400);
	case 'array':
		#-------------------------------------------------------------------------------
		$TemplateID = $Server['Code'];
		#-------------------------------------------------------------------------------
		break;
		#-------------------------------------------------------------------------------
	default:
		return ERROR | @Trigger_Error(101);
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Template = System_XML(SPrintF('servers/%s.xml',$TemplateID));
if(Is_Error($Template))
	return new gException('ERROR_TEMPLATE_LOAD','Ошибка загрузки шаблона');
#-------------------------------------------------------------------------------
$Params = $Template['Attribs'];
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
$Errors = $Attribs = Array();
#-------------------------------------------------------------------------------
foreach(Array_Keys($Params) as $AttribID){
	#-------------------------------------------------------------------------------
	$Attrib = $Params[$AttribID];
	#-------------------------------------------------------------------------------
	$Value = (IsSet($Args[$AttribID])?$Args[$AttribID]:$Params[$AttribID]['Value']);
	#-------------------------------------------------------------------------------
	$Attribs[$AttribID] = $Value;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	switch($Attrib['Type']){
	case 'Input':
		# No more...
	case 'TextArea':
		#-------------------------------------------------------------------------------
		if($Value){
			#-------------------------------------------------------------------------------
			$Check = $Attrib['Check'];
			#-------------------------------------------------------------------------------
			if(IsSet($Regulars[$Check]))
				$Check = $Regulars[$Check];
			#-------------------------------------------------------------------------------
			if(!Preg_Match($Check,$Value))
				$Errors[] = $AttribID;
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			if($Attrib['IsDuty'])
				$Errors[] = $AttribID;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		break;
		#-------------------------------------------------------------------------------
	case 'Select':
		#-------------------------------------------------------------------------------
		if(!IsSet($Attrib['Options'][$Value]))
			$Errors[] = $AttribID;
		#-------------------------------------------------------------------------------
		break;
		#-------------------------------------------------------------------------------
	default:
		return ERROR | @Trigger_Error(100);
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Count($Errors)){
	#-------------------------------------------------------------------------------
	$Attribs1 = $Template['Attribs'];
	#-------------------------------------------------------------------------------
	$Parent = NULL;
	#-------------------------------------------------------------------------------
	$Errors = Array_Reverse($Errors);
	#-------------------------------------------------------------------------------
	foreach($Errors as $AttribID){
		#-------------------------------------------------------------------------------
		$Attrib = $Attribs1[$AttribID];
		#-------------------------------------------------------------------------------
		$Exception = new gException(StrToUpper($AttribID),$Attrib['Comment'],$Parent);
		#-------------------------------------------------------------------------------
		$Parent = $Exception;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(IsSet($Exception))
		return new gException('FIELDS_WRONG_FILLED','Не верно заполнены поля',$Exception);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Replace = Array_ToLine($Attribs,'%');
#-------------------------------------------------------------------------------
$ServerName = $Template['ServerName'];
#-------------------------------------------------------------------------------
foreach(Array_Keys($Replace) as $Key)
	$ServerName = Str_Replace($Key,$Replace[$Key],$ServerName);
#-----------------------------TRANSACTION---------------------------------------
if(Is_Error(DB_Transaction($TransactionID = UniqID('ServerEdit'))))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$UServer = Array('ServiceID'=>$ServiceID,'Attribs'=>$Attribs);
#-------------------------------------------------------------------------------
$Answer = Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
if($ServerID){
  #-----------------------------------------------------------------------------
  $IsUpdate = DB_Update('Servers',$UServer,Array('ID'=>$ServerID));
  if(Is_Error($IsUpdate))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  $Contracts = DB_Select('Contracts',Array('ID','StatusID'),Array('Where'=>SPrintF('`ServerID` = %u',$ServerID)));
  #-----------------------------------------------------------------------------
  switch(ValueOf($Contracts)){
    case 'error':
      return ERROR | @Trigger_Error(500);
    case 'exception':
      # No more...
    break;
    case 'array':
      #-------------------------------------------------------------------------
      foreach($Contracts as $Contract){
        #-----------------------------------------------------------------------
        $ContractID = (integer)$Contract['ID'];
        #-----------------------------------------------------------------------
      }
    break;
    default:
      return ERROR | @Trigger_Error(100);
  }
}else{
  #-----------------------------------------------------------------------------
  $UServer = Array_Merge($UServer,Array('TemplateID'=>$TemplateID,'UserID'=>$__USER['ID']));
  #-----------------------------------------------------------------------------
  $ServerID = DB_Insert('Servers',$UServer);
  if(Is_Error($ServerID))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  if($__USER['ID'] == 100){
    #---------------------------------------------------------------------------
    $Count = DB_Count('Servers',Array('ID'=>100));
    if(Is_Error($Count))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    if(!$Count){
      #-------------------------------------------------------------------------
      $IsUpdate = DB_Update('Servers',Array('ID'=>100),Array('ID'=>$ServerID));
      if(Is_Error($IsUpdate))
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
      $ServerID = 100;
    }
  }
  #-----------------------------------------------------------------------------
  $Answer['ServerID'] = $ServerID;
}
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
if(Is_Error(DB_Commit($TransactionID)))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if($Window){
  #-----------------------------------------------------------------------------
  $Window = JSON_Decode(Base64_Decode($Window),TRUE);
  #-----------------------------------------------------------------------------
  $Window['Args']['ServerID'] = $ServerID;
  #-----------------------------------------------------------------------------
  $Answer = Array('Status'=>'Window','Window'=>$Window);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Answer;
#-------------------------------------------------------------------------------

?>
