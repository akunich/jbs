<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
$ServerID	= (integer) @$Args['ServerID'];
$TemplateID	=  (string) @$Args['TemplateID'];
$TemplatesIDs	=  (string) @$Args['TemplatesIDs'];
$Simple		=  (string) @$Args['Simple'];
$Window		=  (string) @$Args['Window'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','classes/DOM.class.php','libs/Tree.php','libs/Upload.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
if($ServerID){
	#-------------------------------------------------------------------------------
	$Server = DB_Select('Servers',Array('ID','ServiceID','(SELECT `Code` FROM `Services` WHERE `Services`.`ID` = `ServiceID`) as `Code`','Params'),Array('UNIQ','ID'=>$ServerID));
	#-------------------------------------------------------------------------------
	switch(ValueOf($Server)){
	case 'error':
		return ERROR | @Trigger_Error(500);
	case 'exception':
		return ERROR | @Trigger_Error(400);
	case 'array':
		#-------------------------------------------------------------------------------
		$TemplateID = $Server['Code'];
		#-------------------------------------------------------------------------------
	default:
		return ERROR | @Trigger_Error(101);
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM = new DOM();
#-------------------------------------------------------------------------------
$Links = &Links();
# Коллекция ссылок
$Links['DOM'] = &$DOM;
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Load('Window')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Form = new Tag('FORM',Array('name'=>'ServerEditForm','onsubmit'=>'return false;'));
#-------------------------------------------------------------------------------
if($Window){
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load(
			'Form/Input',
			Array(
				'name'  => 'Window',
				'type'  => 'hidden',
				'value' => $Window
				)
			);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Form->AddChild($Comp);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$TemplateID){
	#-------------------------------------------------------------------------------
	$DOM->AddText('Title','Новый сервер');
	#-------------------------------------------------------------------------------
	$Templates = $Config['Servers']['Templates'];
	#-------------------------------------------------------------------------------
	$Options = Array();
	#-------------------------------------------------------------------------------
	$TemplatesIDs = ($TemplatesIDs?Explode(',',$TemplatesIDs):Array());
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Templates) as $TemplateID){
		#-------------------------------------------------------------------------------
		if(Count($TemplatesIDs) && !In_Array($TemplateID,$TemplatesIDs))
			continue;
		#-------------------------------------------------------------------------------
		$Template = $Templates[$TemplateID];
		#-------------------------------------------------------------------------------
		if($Template['IsActive'])
			$Options[$TemplateID] = $Templates[$TemplateID]['Name'];
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!Count($Options))
		return new gException('TEMPLATES_NOT_DEFINED','Шаблоны не определены');
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('Form/Select',Array('name'=>'TemplateID'),$Options);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Table = Array(Array('Шаблон',$Comp));
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load(
			'Form/Input',
			Array(
				'onclick' => "ShowWindow('/Administrator/ServerEdit',FormGet(form));",
				'type'    => 'button',
				'value'   => 'Продолжить'
				)
			);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Table[] = $Comp;
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('Tables/Standard',$Table);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Form->AddChild($Comp);
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	$DOM->AddText('Title',$Config['Servers']['Templates'][$TemplateID]['Name']);
	#-------------------------------------------------------------------------------
	#$Script = new Tag('SCRIPT',Array('type'=>'text/javascript','src'=>'SRC:{Js/Pages/ServerEdit.js}'));
	#-------------------------------------------------------------------------------
	#$DOM->AddChild('Head',$Script);
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load(
			'Form/Input',
			Array(
				'name'  => 'TemplateID',
				'type'  => 'hidden',
				'value' => $TemplateID
				)
			);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Form->AddChild($Comp);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if($ServerID){
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load(
				'Form/Input',
				Array(
					'name'  => 'ServerID',
					'type'  => 'hidden',
					'value' => $Server['ID']
					)
				);
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Form->AddChild($Comp);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Template = System_XML(SPrintF('servers/%s.xml',$TemplateID));
	if(Is_Error($Template))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	if($Simple){
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load(
				'Form/Input',
				Array(
					'name'  => 'Simple',
					'type'  => 'hidden',
					'value' => $Simple
					)
				);
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Form->AddChild($Comp);
		#-------------------------------------------------------------------------------
		$Simple = @JSON_Decode(Base64_Decode($Simple),TRUE);
		if(!$Simple)
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Simple = Array();
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Attribs = $Template['Attribs'];
	#-------------------------------------------------------------------------------
	$Replace = Array_ToLine($__USER,'%');
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Attribs) as $AttribID){
		#-------------------------------------------------------------------------------
		$Attrib = $Attribs[$AttribID];
		#-------------------------------------------------------------------------------
		if(Count($Simple)){
			#-------------------------------------------------------------------------------
			if(IsSet($Simple[$AttribID])){
				#-------------------------------------------------------------------------------
				$Attrib['IsDuty'] = $Simple[$AttribID];
				#-------------------------------------------------------------------------------
			}else{
				#-------------------------------------------------------------------------------
				continue;
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		if(IsSet($Attrib['Title']))
			$Table[] = $Attrib['Title'];
		#-------------------------------------------------------------------------------
		if($ServerID){
			#-------------------------------------------------------------------------------
			$Value = (string)@$Server['Attribs'][$AttribID];
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			$Value = $Attrib['Value'];
			#-------------------------------------------------------------------------------
			foreach(Array_Keys($Replace) as $Key)
				$Value = Str_Replace($Key,$Replace[$Key],$Value);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$Params = &$Attrib['Attribs'];
		#-------------------------------------------------------------------------------
		$Params['name'] = $AttribID;
		#-------------------------------------------------------------------------------
		if($Attrib['IsDuty'])
			$Params['class'] = 'Duty';
		#-------------------------------------------------------------------------------
		switch($Attrib['Type']){
		case 'Input':
			#-------------------------------------------------------------------------------
			$Params['value'] = $Value;
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/Input',$Params);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		case 'TextArea':
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/TextArea',$Params,$Value);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		case 'Select':
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/Select',$Params,$Attrib['Options'],$Value);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$NoBody = new Tag('NOBODY',new Tag('SPAN',$Attrib['Comment']));
		#-------------------------------------------------------------------------------
		$NoBody->AddChild(new Tag('BR'));
		#-------------------------------------------------------------------------------
		if(IsSet($Attrib['Example']))
			$NoBody->AddChild(new Tag('SPAN',Array('class'=>'Comment'),SPrintF('Например: %s',$Attrib['Example'])));
		#-------------------------------------------------------------------------------
		$Table[] = Array($NoBody,$Comp);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!$Simple){
		#-------------------------------------------------------------------------------
		$Table[] = 'Подтверждение введенных данных';
		#-------------------------------------------------------------------------------
		$Document = $ServerID?GetUploadedFileSize('Servers', $ServerID):0;
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load('Upload','Document',$Document?SPrintF('%01.2f Кб.',$Document/1024):'не загружены');
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Table[] = Array('Копия документа подтверждающего достоверность данных',$Comp);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!$GLOBALS['__USER']['IsAdmin']){
		#-------------------------------------------------------------------------------
		$Table[] = 'Обработка персональных данных №152-ФЗ "О персональных данных"';
		#-------------------------------------------------------------------------------
		$Agree = 'Я подтверждаю своё согласие на передачу информации в электронной форме (в том числе персональных данных) по открытым каналам связи сети Интернет.';
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load('Form/Input',Array('name'=>'Agree','type'=>'checkbox','value'=>'yes','prompt'=>$Agree));
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Table[] = Array($Agree,$Comp);
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$Agree = 'Я разрешаю передачу своих персональных данных третьим лицам, для выполнения заказанных мною услуг (регистрация доменов и т.п.)';
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load('Form/Input',Array('name'=>'AgreeHandle','type'=>'checkbox','value'=>'yes','prompt'=>$Agree));
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Table[] = Array($Agree,$Comp);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Table[] = 'Проверка корректности введённых данных';
		#-------------------------------------------------------------------------------
		$Prompt = 'При установке галочки проверяется правильность заполнения полей с данными. Если галочку не устанавливать - проверка не производится, можно сохранить неполный профиль, но, также, пропускаются ошибки заполнения.';
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load('Form/Input',Array('name'=>'CheckFields','type'=>'checkbox','checked'=>'yes','value'=>'yes','prompt'=>$Prompt));
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Table[] = Array('Проверить данные',$Comp);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load(
			'Form/Input',
			Array(
				'type'    => 'button',
				'onclick' => SPrintF("FormEdit('/Administrator/API/ServerEdit','ServerEditForm','%s');",($ServerID?'Сохранение настроек':'Добавление сервера')),
				'value'   => ($ServerID?'Сохранить':'Зарегистрировать')
				)
			);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Table[] = $Comp;
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('Tables/Standard',$Table,Array('style'=>'width:500px;'));
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Form->AddChild($Comp);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM->AddChild('Into',$Form);
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Build(FALSE)))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok','DOM'=>$DOM->Object);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
