<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
$DomainName	=  (string) @$Args['DomainName'];
$DomainZone	=  (string) @$Args['DomainZone'];
$IsAvalible	= (boolean) @$Args['IsAvalible'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('libs/WhoIs.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Interface']['User']['Orders']['Domain']['DomainWhoIs'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$CacheID = Md5(SPrintF('WhoIs-%s.%s',$DomainName,$DomainZone));
#-------------------------------------------------------------------------------
$IsCheck = CacheManager::get($CacheID);
#-------------------------------------------------------------------------------
if(!$IsCheck){
	#-------------------------------------------------------------------------------
	# смотрим доменную зону, на предмет того использовать ли данные whois сервера, или юзать запросы к регистратору
	$DomainZones = System_XML('config/DomainZones.xml');
	if(Is_Error($DomainZones))
		return ERROR | @Trigger_Error('[comp/www/API/WhoIs]: не удалось загрузить базу WhoIs серверов');
	#-------------------------------------------------------------------------------
        $IsSuppoted = FALSE;
	#-------------------------------------------------------------------------------
	foreach($DomainZones as $Zone){
		#-------------------------------------------------------------------------------
		if($Zone['Name'] == $DomainZone){
			#-------------------------------------------------------------------------------
			$IsSuppoted = TRUE;
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	if(!$IsSuppoted || $Zone['IsUseRegistratorWhoIs']){
		#-------------------------------------------------------------------------------
		if(!$IsSuppoted)
			Debug(SPrintF('[comp/www/API/WhoIs]: доменная зона не поддерживается'));
		#-------------------------------------------------------------------------------
		if($IsSuppoted && $Zone['IsUseRegistratorWhoIs'])
			Debug(SPrintF('[comp/www/API/WhoIs]: принудительное использование WhoIs регистратора'));
		#-------------------------------------------------------------------------------





	}








	#-------------------------------------------------------------------------------
	$IsCheck = WhoIs_Check($DomainName,$DomainZone);
	#-------------------------------------------------------------------------------
	CacheManager::add($CacheID,$IsCheck,IntVal($Settings['CacheTime']));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
switch(ValueOf($IsCheck)){
case 'error':
	return Array('Status'=>'Fail');
case 'exception':
	return $IsCheck;
case 'false':
	return new gException('DOMAIN_ZONE_NOT_SUPPORTED','Доменная зона не поддерживается');
case 'array':
	#-------------------------------------------------------------------------------
	$IsCheck['Status'] = 'Borrowed';
	#-------------------------------------------------------------------------------
	return $IsCheck;
	#-------------------------------------------------------------------------------
case 'true':
	#-------------------------------------------------------------------------------
	return Array('Status'=>'Free');
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
