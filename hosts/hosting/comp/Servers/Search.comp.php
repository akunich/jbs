<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for wwww.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('LinkID');
/******************************************************************************/
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Links = &Links();
# Коллекция ссылок
$Template = &$Links[$LinkID];
/******************************************************************************/
/******************************************************************************/
$Tr = new Tag('TR');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$ServersGroups = DB_Select('ServersGroups',Array('ID','Name','(SELECT `Code` FROM `Services` WHERE `Services`.`ID`=`ServiceID`) AS `Code`'),Array('SortOn'=>'SortID'));
#-------------------------------------------------------------------------------
switch(ValueOf($ServersGroups)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	break;
case 'array':
	#-------------------------------------------------------------------------------
	$Table = $Options = Array();
	#-------------------------------------------------------------------------------
	$Options['Default'] = 'Не указана';
	#-------------------------------------------------------------------------------
	foreach($ServersGroups as $ServersGroup)
		$Options[$ServersGroup['ID']] = SPrintF('%s/%s',$ServersGroup['Code'],$ServersGroup['Name']);
	#-------------------------------------------------------------------------------
	$ServersGroupID = 'Default';
	#-------------------------------------------------------------------------------
	$Session = &$Template['Session'];
	#-------------------------------------------------------------------------------
	if(IsSet($Session['ServersGroupID']))
		$ServersGroupID = $Session['ServersGroupID'];
	#-------------------------------------------------------------------------------
	$Args = Args();
	#-------------------------------------------------------------------------------
	if(IsSet($Args['ServersGroupID']))
		$ServersGroupID = $Args['ServersGroupID'];
	#-------------------------------------------------------------------------------
	$Session['ServersGroupID'] = $ServersGroupID;
	#-------------------------------------------------------------------------------
	$AddingWhere = &$Template['Source']['Adding']['Where'];
	#-------------------------------------------------------------------------------
	if($ServersGroupID != 'Default')
		$AddingWhere[] = SPrintF('`ServersGroupID` = %u',$ServersGroupID);
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('Form/Select',Array('name'=>'ServersGroupID','onchange'=>'TableSuperReload();'),$Options,$ServersGroupID);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Tr->AddChild(new Tag('NOBODY',new Tag('TD',Array('class'=>'Comment'),new Tag('NOBR','Группа серверов')),new Tag('TD',$Comp)));
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Services = DB_Select('Services',Array('ID','NameShort'),Array('Where'=>'`IsHidden` != "yes"','SortOn'=>'SortID'));
#-------------------------------------------------------------------------------
switch(ValueOf($Services)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	break;
case 'array':
	#-------------------------------------------------------------------------------
	$Table = $Options = Array();
	#-------------------------------------------------------------------------------
	$Options['Default'] = 'Не указан';
	#-------------------------------------------------------------------------------
	foreach($Services as $Service)
		$Options[$Service['ID']] = SPrintF('%s',$Service['NameShort']);
	#-------------------------------------------------------------------------------
	$ServiceID = 'Default';
	#-------------------------------------------------------------------------------
	$Session = &$Template['Session'];
	#-------------------------------------------------------------------------------
	if(IsSet($Session['ServiceID']))
		$ServiceID = $Session['ServiceID'];
	#-------------------------------------------------------------------------------
	$Args = Args();
	#-------------------------------------------------------------------------------
	if(IsSet($Args['ServiceID']))
		$ServiceID = $Args['ServiceID'];
	#-------------------------------------------------------------------------------
	$Session['ServiceID'] = $ServiceID;
	#-------------------------------------------------------------------------------
	$AddingWhere = &$Template['Source']['Adding']['Where'];
	#-------------------------------------------------------------------------------
	if($ServiceID != 'Default')
		$AddingWhere[] = SPrintF('(SELECT `ServiceID` FROM `ServersGroups` WHERE `ServersGroups`.`ID`=`Servers`.`ServersGroupID`) = %u',$ServiceID);
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('Form/Select',Array('name'=>'ServiceID','onchange'=>'TableSuperReload();'),$Options,$ServiceID);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Tr->AddChild(new Tag('NOBODY',new Tag('TD',Array('class'=>'Comment'),'Сервис'),new Tag('TD',$Comp)));
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!Count($Tr->Childs))
	return FALSE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return new Tag('TABLE',Array('class'=>'Standard','cellspacing'=>5),$Tr);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
