<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Task');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Count = DB_Count('Servers');
if(Is_Error($Count))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if($Count){
	#-------------------------------------------------------------------------------
	for($i=0;$i<$Count;$i+=10){
		#-------------------------------------------------------------------------------
		$Servers = DB_Select('Servers',Array('ID','TemplateID','Params'),Array('Limits'=>Array('Start'=>$i,'Length'=>10)));
		#-------------------------------------------------------------------------------
		switch(ValueOf($Servers)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			# No more...
			break;
		case 'array':
			#-------------------------------------------------------------------------------
			$Attribs = Array();
			#-------------------------------------------------------------------------------
			foreach($Servers as $Server){
				#-------------------------------------------------------------------------------
				$Attribs = $Server['Params'];
				#-------------------------------------------------------------------------------
				$Template = System_XML(SPrintF('servers/%s.xml',$Server['TemplateID']));
				if(Is_Error($Template))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
				if(IsSet($Template['Attribs'])){
					#-------------------------------------------------------------------------------
					foreach(Array_Keys($Template['Attribs']) as $AttribID)
						if(!IsSet($Attribs[$AttribID]))
							$Attribs[$AttribID] = $Template['Attribs'][$AttribID]['Value'];
					#-------------------------------------------------------------------------------
					foreach(Array_Keys($Attribs) as $AttribID)
						if(!IsSet($Template['Attribs'][$AttribID]))
							UnSet($Attribs[$AttribID]);
					#-------------------------------------------------------------------------------
				}
				#-------------------------------------------------------------------------------
				$IsUpdate = DB_Update('Servers',Array('Params'=>$Attribs),Array('ID'=>$Server['ID']));
				if(Is_Error($IsUpdate))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
        $Event = Array(
			'UserID'        => 100,
			'PriorityID'    => 'Hosting',
			'Text'          => SPrintF('Успешно восстановлено %u серверов',$Count)
			);
	$Event = Comp_Load('Events/EventInsert',$Event);
	if(!$Event)
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$GLOBALS['TaskReturnInfo'] = SPrintF('Recovered: %u servers',$Count);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(IsSet($GLOBALS['IsCron']))
	return TRUE;
#-------------------------------------------------------------------------------
return $Count;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
