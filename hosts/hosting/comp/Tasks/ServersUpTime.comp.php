<?php

#-------------------------------------------------------------------------------
/** @author Лапшин С.М. (Joonte Ltd)*/
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['ServersUpTime'];
#-------------------------------------------------------------------------------
$ExecuteTime = Comp_Load('Formats/Task/ExecuteTime',Array('ExecutePeriod'=>$Settings['ExecutePeriod']));
if(Is_Error($ExecuteTime))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return 3600;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$HostingServers = DB_Select('HostingServers',Array('ID','Address','Port','Services'),Array('SortOn'=>'Address'));
#-------------------------------------------------------------------------------
switch(ValueOf($HostingServers)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    # No more..
  break;
  case 'array':
    #---------------------------------------------------------------------------
    $GLOBALS['TaskReturnInfo'] = Array();
    #---------------------------------------------------------------------------
    foreach($HostingServers as $HostingServer){
      #-------------------------------------------------------------------------
      $GLOBALS['TaskReturnInfo'][] = $HostingServer['Address'];
      #-------------------------------------------------------------------------
      $IsOK = TRUE;
      #-------------------------------------------------------------------------
      $Services = Preg_Split('/\n+/',$HostingServer['Services']);
      #-------------------------------------------------------------------------
      foreach($Services as $Service){
        #-----------------------------------------------------------------------
        $Service = Explode('=',$Service);
        #-----------------------------------------------------------------------
        $ServiceName = Current($Service);
	#-----------------------------------------------------------------------
	$Port = IntVal(Next($Service));
        #-----------------------------------------------------------------------
	#Debug(SPrintF('[comp/Tasks/ServersUpTime]: connect to %s:%u',$HostingServer['Address'],$Port));
	#-----------------------------------------------------------------------
	$Socket = @FsockOpen($HostingServer['Address'],$Port,$nError,$sError,$Settings['SocketTimeout']);
        #-----------------------------------------------------------------------
        if(!Is_Resource($Socket)){
	  #-----------------------------------------------------------------------
	  #Debug(SPrintF('[comp/Tasks/ServersUpTime]: cannot connect %s:%u with error: %s (%s)',$HostingServer['Address'],$Port,$sError,$nError));
          $IsOK = FALSE;
	  #-----------------------------------------------------------------------
	}
        #----------------------------------------------------------------------- 
        $IPage = Array(
          #---------------------------------------------------------------------
          'TestDate' => Time(),
          'ServerID' => $HostingServer['ID'],
          'Service'  => Trim($ServiceName),
          'UpTime'   => (Is_Resource($Socket)?100:0),
          'Day'      => Date('d'),
          'Month'    => Date('m'),
          'Year'     => Date('Y')
        );
        #-----------------------------------------------------------------------
        $IsInsert = DB_Insert('ServersUpTime',$IPage);
        if(Is_Error($IsInsert))
          return ERROR | @Trigger_Error(500);
	#-----------------------------------------------------------------------
	if(Is_Resource($Socket))
	  FClose($Socket);
	#-----------------------------------------------------------------------
      }
      #-------------------------------------------------------------------------
      $IsUpdate = DB_Update('HostingServers',Array('TestDate'=>Time(),'IsOK'=>$IsOK),Array('ID'=>$HostingServer['ID']));
      if(Is_Error($IsUpdate))
        return ERROR | @Trigger_Error(500);
    }
  break;
  default:
    return ERROR | @Trigger_Error(500);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $ExecuteTime;
#-------------------------------------------------------------------------------

?>
