<?php

#-------------------------------------------------------------------------------
/** @author Лапшин С.М. (Joonte Ltd)*/
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['ServersUpTime'];
#-------------------------------------------------------------------------------
$ExecuteTime = Comp_Load('Formats/Task/ExecuteTime',Array('ExecutePeriod'=>$Settings['ExecutePeriod']));
if(Is_Error($ExecuteTime))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return 3600;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Servers = DB_Select('Servers',Array('ID','Address','Port','Monitoring'),Array('SortOn'=>Array('ServersGroupID','Address')));
#-------------------------------------------------------------------------------
switch(ValueOf($Servers)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return $ExecuteTime;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(500);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$GLOBALS['TaskReturnInfo'] = Array();
#-------------------------------------------------------------------------------
foreach($Servers as $Server){
	#-------------------------------------------------------------------------------
	$GLOBALS['TaskReturnInfo'][] = $Server['Address'];
	#-------------------------------------------------------------------------------
	if(StrLen($Server['Monitoring']) > 3){
		#-------------------------------------------------------------------------------
		$Services = Preg_Split('/\n+/',$Server['Monitoring']);
		#-------------------------------------------------------------------------------
		foreach($Services as $Service){
			#-------------------------------------------------------------------------------
			$Service = Explode('=',$Service);
			#-------------------------------------------------------------------------------
			$ServiceName = Current($Service);
			#-------------------------------------------------------------------------------
			$Port = IntVal(Next($Service));
			#-------------------------------------------------------------------------------
			#Debug(SPrintF('[comp/Tasks/ServersUpTime]: connect to %s:%u',$Server['Address'],$Port));
			#-------------------------------------------------------------------------------
			$Socket = @FsockOpen($Server['Address'],$Port,$nError,$sError,$Settings['SocketTimeout']);
			#-------------------------------------------------------------------------------
			if(!Is_Resource($Socket)){
				#-------------------------------------------------------------------------------
				#Debug(SPrintF('[comp/Tasks/ServersUpTime]: cannot connect %s:%u with error: %s (%s)',$Server['Address'],$Port,$sError,$nError));
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
			$IPage = Array(
					'TestDate'	=> Time(),
					'ServerID'	=> $Server['ID'],
					'Service'	=> Trim($ServiceName),
					'UpTime'	=> (Is_Resource($Socket)?100:0),
					'Day'		=> Date('d'),
					'Month'		=> Date('m'),
					'Year'		=> Date('Y')
					);
			#-------------------------------------------------------------------------------
			$IsInsert = DB_Insert('ServersUpTime',$IPage);
			if(Is_Error($IsInsert))
				return ERROR | @Trigger_Error(500);
			#-------------------------------------------------------------------------------
			if(Is_Resource($Socket))
				FClose($Socket);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		# рассчиытваем значение IsOK
		$UpTimes = DB_Select('ServersUpTime',Array('(SUM(`UpTime`*`Count`)/SUM(`Count`)) as `UpTime`'),Array('UNIQ','Where'=>SPrintF('`TestDate` > UNIX_TIMESTAMP() - %u * 24 * 60 *60  AND `ServerID` = %u',($Settings['DaysAgregate'])?$Settings['DaysAgregate']:1,$Server['ID'])));
		switch(ValueOf($Server)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			return ERROR | @Trigger_Error(400);
		case 'array':
			break;
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$IsOK = TRUE;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$IsOK = IsSet($IsOK)?NULL:Round($UpTimes['UpTime']);
	#-------------------------------------------------------------------------------
	$IsUpdate = DB_Update('Servers',Array('TestDate'=>Time(),'IsOK'=>$IsOK),Array('ID'=>$Server['ID']));
	if(Is_Error($IsUpdate))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	UnSet($IsOK);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $ExecuteTime;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
