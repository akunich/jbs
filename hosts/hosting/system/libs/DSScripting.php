<?php
#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('libs/HTTP.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
Require_Once(SPrintF('%s/others/hosting/IDNA.php',SYSTEM_PATH));
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Create($Settings,$Switch){
	/******************************************************************************/
	$__args_types = Array('array','string');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!$Switch)
		return new gException('SWITCH_PORT_NOT_SET',SPrintF("Не указан порт коммутатора в который подключён сервер"));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['PortUp'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Create" "%s" 2>&1',$File,$Switch),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Create]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Active($Settings,$Switch){
	/******************************************************************************/
	$__args_types = Array('array','string');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!$Switch)
		return new gException('SWITCH_PORT_NOT_SET',SPrintF("Не указан порт коммутатора в который подключён сервер"));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['PortUp'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Active" "%s" 2>&1',$File,$Switch),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Active]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Delete($Settings,$Switch){
	/******************************************************************************/
	$__args_types = Array('array','string');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!$Switch)
		return new gException('SWITCH_PORT_NOT_SET',SPrintF("Не указан порт коммутатора в который подключён сервер"));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['PortUp'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Delete" "%s" 2>&1',$File,$Switch),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Delete]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Suspend($Settings,$Switch){
	/******************************************************************************/
	$__args_types = Array('array','string');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!$Switch)
		return new gException('SWITCH_PORT_NOT_SET',SPrintF("Не указан порт коммутатора в который подключён сервер"));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['PortUp'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Suspend" "%s" 2>&1',$File,$Switch),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Suspend]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# Функции используемые для внутреннего употребления =)
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# надо вынести сюда кусок повторяющийся во всех функциях
function DSScripting_Build_HTTP($Settings){
	/******************************************************************************/
	$__args_types = Array('array');
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	$HTTP = Array(
			'Address'	=> $Settings['Params']['IP'],
			'Port'		=> $Settings['Port'],
			'Host'		=> $Settings['Address'],
			'Protocol'	=> $Settings['Protocol'],
			'Hidden'	=> $authinfo,
			'IsLogging'	=> $Settings['Params']['IsLogging']
			);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return $HTTP;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}


?>
