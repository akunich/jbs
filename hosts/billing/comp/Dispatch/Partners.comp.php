<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru  */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('IsSearch');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/

# create temporary table
$Result = DB_Query("CREATE TEMPORARY TABLE `UsrOwners` SELECT DISTINCT `OwnerID` as `DistinctOwnerID`, (SELECT `Email` FROM `Users` WHERE `ID`=`DistinctOwnerID`) AS `Email`, COUNT(`ID`) AS `NumDependUsers` FROM `Users` WHERE `OwnerID`!=1 GROUP BY `OwnerID`");
if(Is_Error($Result))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

$Filters = Array('Партнёрская программа');
$Filter = Array('Name'=>'Пользователи с рефералами','UsersIDs'=>Array());


$Owners = DB_Select('UsrOwners','*');
#-------------------------------------------------------------------------------
switch(ValueOf($Owners)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    return FALSE;
  case 'array':
    #---------------------------------------------------------------------------
    $UsersIDs = Array();
    #---------------------------------------------------------------------------
    foreach($Owners as $Owner){
	$UsersIDs[] = $Owner['DistinctOwnerID'];
 	#-----------------------------------------------------------------------
    }
    #---------------------------------------------------------------------------
    #---------------------------------------------------------------------------
    Array_Unique($UsersIDs);
    #---------------------------------------------------------------------------
    $Filter['UsersIDs'] = $UsersIDs;
    #---------------------------------------------------------------------------
    $Filters['UsersWithReferals'] = $Filter;
    #---------------------------------------------------------------------------
    return $Filters;
  default:
    return ERROR | @Trigger_Error(101);
}
return FALSE;
#-------------------------------------------------------------------------------

?>
