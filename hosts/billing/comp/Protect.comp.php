<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Value');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Codes = System_XML('tmp/protect.xml');
if(Is_Error($Codes))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
Debug(SPrintF('[comp/Protect]: Codes = %s',print_r($Codes,true)));
#-------------------------------------------------------------------------------
// перебираем коды из файла
foreach(Array_Keys($Codes) as $CodeID){
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Protect]: CodeID = %s; Secret = %s',$CodeID,$Codes[$CodeID]['Secret']));
	#-------------------------------------------------------------------------------
	// удлаяем старые, старее 5 минут
	if(Time() - $Codes[$CodeID]['Date'] > 300){
		#-------------------------------------------------------------------------------
		UnSet($Codes[$CodeID]);
		#-------------------------------------------------------------------------------
		// пропускаем, код-то устарел
		continue;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// если значение совпадает
	if(($Value == $Codes[$CodeID]['Secret'])){
		#-------------------------------------------------------------------------------
		// удаляем код из массива
		UnSet($Codes[$CodeID]);
		#-------------------------------------------------------------------------------
		// сохраяем файл
		$XML = To_XML_String($Codes);
		if(Is_Error($XML))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Tmp = System_Element('tmp');
		if(Is_Error($Tmp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$IsWrite = IO_Write(SPrintF('%s/protect.xml',$Tmp),$XML,TRUE);
		if(Is_Error($IsWrite))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		return TRUE;
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return FALSE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------


?>
