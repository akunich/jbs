<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$Messages	= (integer) @$Args['Messages'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($Messages > 9)
	$Messages = '9+';
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
Debug(SPrintF('[comp/www/favicon]: Messages = %s',$Messages));
#-------------------------------------------------------------------------------
Header('Content-type: image');
Header('Cache-Control: private, max-age=86400');
#-------------------------------------------------------------------------------
$Path = Styles_Element(SPrintF('Images/favicon.%s',($Messages)?'png':'ico'));
if(Is_Error($Path))
	return SPrintF('favicon.%s not found',($Messages)?'png':'ico');
#-------------------------------------------------------------------------------
$Icon = IO_Read($Path);
if(Is_Error($Icon))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($Messages){
	#-------------------------------------------------------------------------------
	# создаём маленькую картинку с числом
	$ImageSmall = @ImageCreate(9,9);
	$BgColor = ImageColorAllocate($ImageSmall,255,0,0);	// красная
	$TextColor = ImageColorAllocate($ImageSmall,0,0,0);	// чёрный
	ImageString($ImageSmall,3,1,-2,$Messages,$TextColor);
	#-------------------------------------------------------------------------------
	# готовим большую картинку
	$ImageBig = @ImageCreateFromPNG($Path);
	#-------------------------------------------------------------------------------
	# накладываем маленькую картинку на большую
	ImageCopyMerge($ImageBig, $ImageSmall, 9, 7, 0, 0, 9, 9, 100);
	$Icon = ImagePNG($ImageBig);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Icon;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
