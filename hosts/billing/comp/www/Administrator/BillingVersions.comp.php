<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Error(System_Load('classes/DOM.class','modules/Authorisation.mod')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM = new DOM();
#-------------------------------------------------------------------------------
$Links = &Links();
#-------------------------------------------------------------------------------
$Links['DOM'] = &$DOM;
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Load('Base')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddAttribs('MenuLeft',Array('args'=>'Administrator/AddIns'));
#-------------------------------------------------------------------------------
$DOM->AddText('Title','Дополнения → Обслуживание системы → Версии компонентов биллинга');
#-------------------------------------------------------------------------------
$NoBody = new Tag('NOBODY');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Table[] = 'Уровень патчей базы данных';
#-------------------------------------------------------------------------------
$PatchLevels = DB_Select('Config',Array('HostID','Value'),Array('Where'=>"`Param`='LastPatchDB'"));
#-------------------------------------------------------------------------------
switch(ValueOf($PatchLevels)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
	break;
case 'array':
	foreach($PatchLevels as $PatchLevel){
		$Table[] = Array($PatchLevel['HostID'],$PatchLevel['Value']);
	}
	#-----------------------------------------------------------------------------
	$Comp = Comp_Load('Tables/Standard',$Table);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-----------------------------------------------------------------------------
	$NoBody->AddChild($Comp);
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Table1[] = 'Уровень патчей файлов';
#---------------------------------------------------------------------------
$HostsIDs = $GLOBALS['HOST_CONF']['HostsIDs'];
#-----------------------------------------------------------------------------
foreach($HostsIDs as $HostID){
	#---------------------------------------------------------------------------
	$LastPatchFile = SPrintF('%s/hosts/%s/.LastPatchFiles',SYSTEM_PATH,$HostID);
	#---------------------------------------------------------------------------
	if(File_Exists($LastPatchFile)){
		#---------------------------------------------------------------------------
		$handle = fopen($LastPatchFile, "rb");
		$FileVer = fread($handle, filesize($LastPatchFile));
		fclose($handle);
		#---------------------------------------------------------------------------
		$Table1[] = Array($HostID, $FileVer);
	}
}
#---------------------------------------------------------------------------
$Comp = Comp_Load('Tables/Standard',$Table1);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#---------------------------------------------------------------------------
$NoBody->AddChild($Comp);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Tab','Administrator/Billing',$NoBody);
if(Is_Error($Comp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddChild('Into',$Comp);
#-------------------------------------------------------------------------------
$Out = $DOM->Build();
#-------------------------------------------------------------------------------
if(Is_Error($Out))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------

?>
