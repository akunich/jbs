<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$Log    =  (string) @$Args['Log'];
$Lines  = (integer) @$Args['Lines'];
$Search =  (string) @$Args['Search'];
$IsWrap = (boolean) @$Args['IsWrap'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
Header('Content-type: text/plain; charset=utf-8');
#-------------------------------------------------------------------------------
$Lines = Max(10,$Lines);
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Logs = SPrintF('%s/logs',$Tmp);
#-------------------------------------------------------------------------------
$Command = SPrintF('tail -n %u %s/%s',$Lines,$Logs,$Log);
#-------------------------------------------------------------------------------
if($Search)
  $Command .= SPrintF(' | grep %s',EscapeShellArg($Search));
#-------------------------------------------------------------------------------
$Command .= ' 2>&1';
#-------------------------------------------------------------------------------
Exec($Command,$Result);
#-------------------------------------------------------------------------------
Array_UnShift($Result,SPrintF("%s\n",$Command));
#-------------------------------------------------------------------------------
if($IsWrap){
  #-----------------------------------------------------------------------------
  for($i=0;$i<Count($Result);$i++)
    $Result[$i] = WordWrap($Result[$i],100,"\n",TRUE);
}
#-------------------------------------------------------------------------------
return Implode("\n",$Result);
#-------------------------------------------------------------------------------

?>
