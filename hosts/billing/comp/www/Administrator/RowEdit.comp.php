<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$TableID =  (string) @$Args['TableID'];
$RowID   = (integer) @$Args['RowID'];
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
if(!Preg_Match($Regulars['ID'],$TableID))
  return ERROR | @Trigger_Error(201);
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','classes/DOM.class.php')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Result = DB_Query(SPrintF('SHOW COLUMNS FROM `%s`',$TableID));
if(Is_Error($Result))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Rows = MySQL::Result($Result);
if(Is_Error($Rows))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$ColumnsTypes = Array();
#-------------------------------------------------------------------------------
foreach($Rows as $Row)
  $ColumnsTypes[$Row['Field']] = $Row;
#-------------------------------------------------------------------------------
$NoTypesDB = &Link_Get('NoTypesDB','boolean');
#-------------------------------------------------------------------------------
$NoTypesDB = TRUE;
#-------------------------------------------------------------------------------
$Row = DB_Select($TableID,'*',Array('UNIQ','ID'=>$RowID));
#-------------------------------------------------------------------------------
switch(ValueOf($Row)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    return ERROR | @Trigger_Error(400);
  case 'array':
    #---------------------------------------------------------------------------
    $DOM = new DOM();
    #---------------------------------------------------------------------------
    $Links = &Links();
    # Коллекция ссылок
    $Links['DOM'] = &$DOM;
    #---------------------------------------------------------------------------
    if(Is_Error($DOM->Load('Window')))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $DOM->AddText('Title',SPrintF('Таблица: %s, запись ID: %s',$TableID,$Row['ID']));
    #---------------------------------------------------------------------------
    $Script = new Tag('SCRIPT',Array('type'=>'text/javascript','src'=>'SRC:{Js/Pages/Administrator/RowEdit.js}'));
    #---------------------------------------------------------------------------
    $DOM->AddChild('Head',$Script);
    #---------------------------------------------------------------------------
    $DOM->AddChild('Into',new Tag('FORM',Array('id'=>'RowEditForm','name'=>'RowEditForm','onsubmit'=>'return false;')));
    #---------------------------------------------------------------------------
    $Table = Array();
    #---------------------------------------------------------------------------
    foreach(Array_Keys($Row) as $ColumnID){
      #-------------------------------------------------------------------------
      $TypeID = $ColumnsTypes[$ColumnID]['Type'];
      #-------------------------------------------------------------------------
      $Value = $Row[$ColumnID];
      #-------------------------------------------------------------------------
      if(Is_Null($Value))
        $Value = '[NULL]';
      #-------------------------------------------------------------------------
      if(Preg_Match('/blob/',$TypeID)){
        #-----------------------------------------------------------------------
        $Comp = Comp_Load('Upload',$ColumnID,SPrintF('%01.2f Кб.',Mb_StrLen($Value)/1024));
        if(Is_Error($Comp))
          return ERROR | @Trigger_Error(500);
      }else{
        #-----------------------------------------------------------------------
        if(Preg_Match('/(int|float)/',$TypeID)){
          #---------------------------------------------------------------------
          $Comp = Comp_Load('Form/Input',Array('name'=>$ColumnID,'value'=>(string)$Value));
          if(Is_Error($Comp))
            return ERROR | @Trigger_Error(500);
        }else{
          #---------------------------------------------------------------------
          $Attribs = Array(
            #-------------------------------------------------------------------
            'name' => $ColumnID,
            'cols' => 40,
            'rows' => 3
          );
          #---------------------------------------------------------------------
          if(StrLen($Value) > 200)
            $Attribs['rows'] = 10;
          #---------------------------------------------------------------------
          $Comp = Comp_Load('Form/TextArea',$Attribs,(string)$Value);
          if(Is_Error($Comp))
            return ERROR | @Trigger_Error(500);
        }
      }
      #-------------------------------------------------------------------------
      $Table[] = Array($ColumnID,$Comp);
    }
    #---------------------------------------------------------------------------
    $Comp = Comp_Load(
      'Form/Input',
      Array(
        'onclick' => 'RowEdit();',
        'type'    => 'button',
        'value'   => 'Обновить'
      )
    );
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Table[] = $Comp;
    #---------------------------------------------------------------------------
    $Comp = Comp_Load('Tables/Standard',$Table);
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $DOM->AddChild('RowEditForm',$Comp);
    #---------------------------------------------------------------------------
    $Comp = Comp_Load(
      'Form/Input',
      Array(
        'name'  => 'TableID',
        'type'  => 'hidden',
        'value' => $TableID
      )
    );
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $DOM->AddChild('RowEditForm',$Comp);
    #---------------------------------------------------------------------------
    $Comp = Comp_Load(
      'Form/Input',
      Array(
        'name'  => 'RowID',
        'type'  => 'hidden',
        'value' => $Row['ID']
      )
    );
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $DOM->AddChild('RowEditForm',$Comp);
    #---------------------------------------------------------------------------
    if(Is_Error($DOM->Build(FALSE)))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    return Array('Status'=>'Ok','DOM'=>$DOM->Object);
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------

?>
