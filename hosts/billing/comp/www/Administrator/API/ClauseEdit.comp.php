<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
$ClauseID   = (integer) @$Args['ClauseID'];
$GroupID    = (integer) @$Args['GroupID'];
$PublicDate = (integer) @$Args['PublicDate'];
$Partition  =  (string) @$Args['Partition'];
$Title      =  (string) @$Args['Title'];
$IsXML      = (boolean) @$Args['IsXML'];
$IsDOM      = (boolean) @$Args['IsDOM'];
$IsPublish  = (boolean) @$Args['IsPublish'];
$Text       =  (string) @$Args['Text'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if($GroupID < 1)
	return new gException('BAD_CATEGORY','Неправильная категория');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$Partition)
  return new gException('PARTITION_IS_EMPTY','Введите раздел статьи');
#-------------------------------------------------------------------------------
if(!$Title)
   return new gException('TITLE_IS_EMPTY','Введите заголовок статьи');
#-------------------------------------------------------------------------------
$Text = Str_Replace('<p>\s{1,}</p>','',Str_Replace('&nbsp','',$Text));
#-------------------------------------------------------------------------------
if($IsXML){
  #-----------------------------------------------------------------------------
  if(Function_Exists('Tidy_Repair_String')){
    #---------------------------------------------------------------------------
    $Config = System_Element('config/tidy.conf');
    if(Is_Error($Config))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Tidy = @Tidy_Repair_String($Text,$Config,'UTF8');
    #---------------------------------------------------------------------------
    if($Tidy)
      $Text = $Tidy;
  }
  #-----------------------------------------------------------------------------
  if($IsDOM){
    #---------------------------------------------------------------------------
    $Text = SPrintF('<NOBODY>%s</NOBODY>',$Text);
    #---------------------------------------------------------------------------
    $XML = String_XML_Parse($Text);
    #---------------------------------------------------------------------------
    if(Is_Exception($XML))
      return $XML;
    else{
      #-------------------------------------------------------------------------
      $XML = Current($XML->Childs);
      #-------------------------------------------------------------------------
      $XML->NamesToUpper();
      #-------------------------------------------------------------------------
      $Text = $XML->ToXMLString();
    }
  }
}
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$Answer = Array('Status'=>'Ok');
#------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Clause = Array(
		'GroupID'	=> $GroupID,
		'PublicDate'	=> $PublicDate,
		'Partition'	=> $Partition,
		'Title'		=> $Title,
		'IsXML'		=> $IsXML,
		'IsDOM'		=> $IsDOM,
		'IsPublish'	=> $IsPublish,
		'Text'		=> $Text,
		);
#-------------------------------------------------------------------------------
if($ClauseID){
	#-----------------------------------------------------------------------------
	$Clause['ChangedDate']	= Time();
	$Clause['EditorID']	= $__USER['ID'];
	#-------------------------------------------------------------------------------
	$IsUpdate = DB_Update('Clauses',$Clause,Array('ID'=>$ClauseID));
	if(Is_Error($IsUpdate))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	$Clause['AuthorID']	= $__USER['ID'];
	#-------------------------------------------------------------------------------
	$ClauseID = DB_Insert('Clauses',$Clause);
	if(Is_Error($ClauseID))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Answer['ClauseID'] = $ClauseID;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Answer;
#-------------------------------------------------------------------------------

?>
