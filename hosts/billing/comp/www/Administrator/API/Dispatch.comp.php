<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$UsersIDs   =   (array) @$Args['UsersIDs'];
$MethodsIDs =   (array) @$Args['MethodsIDs'];
$Logic      =  (string) @$Args['Logic'];
$FromID     = (integer) @$Args['FromID'];
$Theme      =  (string) @$Args['Theme'];
$Message    =  (string) @$Args['Message'];
$FiltersIDs =   (array) @$Args['FiltersIDs'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Array = Array();
#-------------------------------------------------------------------------------
foreach($UsersIDs as $UserID)
	$Array[] = (integer)$UserID;
#-------------------------------------------------------------------------------
$UsersIDs = $Array;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Methods = Array();
foreach($MethodsIDs as $Method)
	$Methods[] = $Method;
#-------------------------------------------------------------------------------
if(!Count($Methods))
	return new gException('METHODS_NOT_SELECTED','Методы рассылки не выбраны');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Dispatches = Array();
#-------------------------------------------------------------------------------
foreach($FiltersIDs as $FilterID){
	#-------------------------------------------------------------------------------
	$FilterID = Explode('|',$FilterID);
	#-------------------------------------------------------------------------------
	$DispatchID = Current($FilterID);
	#-------------------------------------------------------------------------------
	if(!IsSet($Dispatches[$DispatchID])){
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load(SPrintF('Dispatch/%s',$DispatchID),TRUE);
		if(Is_Error($Comp))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Dispatches[$DispatchID] = $Comp;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Dispatch = $Dispatches[$DispatchID];
	#-------------------------------------------------------------------------------
	if($Dispatch){
		#-------------------------------------------------------------------------------
		$FilterID = Next($FilterID);
		#-------------------------------------------------------------------------------
		if(IsSet($Dispatch[$FilterID])){
			#-------------------------------------------------------------------------------
			$Filter = $Dispatch[$FilterID];
			#-------------------------------------------------------------------------------
			$UsersIDs = Array_Merge($UsersIDs,$Filter['UsersIDs']);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#Debug(SPrintF('[comp/www/Administrator/API/Dispatch]: into filters, UserIDs = %s',Implode(',',$UsersIDs)));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
switch($Logic){
case 'AND':
	#-------------------------------------------------------------------------------
	$Matches = Array_Count_Values($UsersIDs);
	#-------------------------------------------------------------------------------
	$UsersIDs = Array();
	#-------------------------------------------------------------------------------
	foreach($Matches as $UserID=>$Match){
		#-------------------------------------------------------------------------------
		if($Match == Count($FiltersIDs))
			$UsersIDs[] = $UserID;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
case 'OR':
	#-------------------------------------------------------------------------------
	Array_Unique($UsersIDs);
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return new gException('WRONG_LOGIC','Не верный способ объединения фильтров');
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!Count($UsersIDs))
	return new gException('FILTERS_USERS_NOT_FOUND','С использованием фильтров ни один из пользователей для рассылки сообщений не найден');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Users = DB_Select('Users','ID',Array('Where'=>SPrintF('`ID` IN (%s)',Implode(',',$UsersIDs))));
#-------------------------------------------------------------------------------
switch(ValueOf($Users)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return new gException('USERS_NOT_FOUND','Пользователи для рассылки уведомлений не найдены');
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Count = DB_Count('Users',Array('ID'=>$FromID));
if(Is_Error($Count))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(!$Count)
	return new gException('SENDER_NOT_FOUND','Отправитель сообщения не найден');
#-------------------------------------------------------------------------------
if(!$Theme)
	return new gException('THEME_IS_EMPTY','Введите тему сообщения');
#-------------------------------------------------------------------------------
if(!$Message)
	return new gException('MESSAGE_IS_EMPTY','Введите сообщение');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Count = 0;
#-------------------------------------------------------------------------------
$SendTo = Array();
#-------------------------------------------------------------------------------
foreach($Users as $User)
	$SendTo[] = $User['ID'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Params = Array(Implode(',',$SendTo),$Theme,$Message,$FromID,'',Implode(',',$Methods));
#-------------------------------------------------------------------------------
#Debug(SPrintF('[comp/www/Administrator/API/Dispatch]: before send, UserIDs = %s',Implode(',',$UsersIDs)));
#-------------------------------------------------------------------------------
$IsAdd = Comp_Load('www/Administrator/API/TaskEdit',Array('UserID'=>$GLOBALS['__USER']['ID'],'TypeID'=>'Dispatch','Params'=>$Params));
#-------------------------------------------------------------------------------
switch(ValueOf($IsAdd)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'array':
	# No more...
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok','Users'=>SizeOf($Users));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
