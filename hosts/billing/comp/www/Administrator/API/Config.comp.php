<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$FunctionID = (string) @$Args['FunctionID'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$ConfigPath = SPrintF('%s/hosts/%s/config/Config.xml',SYSTEM_PATH,HOST_ID);
#-------------------------------------------------------------------------------
if(File_Exists($ConfigPath)){
  #-----------------------------------------------------------------------------
  $File = IO_Read($ConfigPath);
  if(Is_Error($File))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  $XML = String_XML_Parse($File);
  if(Is_Exception($XML))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  $Config = $XML->ToArray();
  #-----------------------------------------------------------------------------
  $Config = $Config['XML'];
}else
  $Config = Array();
#-------------------------------------------------------------------------------
switch($FunctionID){
  case 'Change':
    #---------------------------------------------------------------------------
    $Path  = (string) @$Args['Path'];
    $Value = (string) @$Args['Value'];
    #---------------------------------------------------------------------------
    $Path = Explode('.',$Path);
    #---------------------------------------------------------------------------
    $Current = &$Config;
    #---------------------------------------------------------------------------
    for($i=0;$i<$Count=Count($Path);$i++){
      #-------------------------------------------------------------------------
      $Element = $Path[$i];
      #-------------------------------------------------------------------------
      if(!IsSet($Current[$Element]))
        $Current[$Element] = ($i != $Count-1?Array():'');
      #-------------------------------------------------------------------------
      $Current = &$Current[$Element];
    }
    #---------------------------------------------------------------------------
    $Current = $Value;
  break;
  case 'Delete':
    #---------------------------------------------------------------------------
    $Path  = (string) @$Args['Path'];
    #---------------------------------------------------------------------------
    $Path = Explode('.',$Path);
    #---------------------------------------------------------------------------
    $String = '';
    #---------------------------------------------------------------------------
    foreach($Path as $Key)
      $String .= SPrintF("['%s']",$Key);
    #---------------------------------------------------------------------------
    Eval(SPrintF('UnSet($Config%s);',$String));
  break;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
$File = IO_Write($ConfigPath,To_XML_String($Config),TRUE);
if(Is_Error($File))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$IsFlush = CacheManager::flush();
if(!$IsFlush)
  @Trigger_Error(500);
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------

?>
