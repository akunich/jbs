<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Null($Args)){
  #-----------------------------------------------------------------------------
  if(Is_Error(System_Load('modules/Authorisation.mod')))
    return ERROR | @Trigger_Error(500);
}
#-------------------------------------------------------------------------------
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
$TaskID      = (integer) @$Args['TaskID'];
$UserID      = (integer) @$Args['UserID'];
$TypeID      =  (string) @$Args['TypeID'];
$Errors      = (integer) @$Args['Errors'];
$ExecuteDate = (integer) @$Args['ExecuteDate'];
$Params      =   (array) @$Args['Params'];
$IsExecuted  = (boolean) @$Args['IsExecuted'];
#-------------------------------------------------------------------------------
if($TaskID){
  #-----------------------------------------------------------------------------
  $Task = DB_Select('Tasks',Array('ID','TypeID'),Array('UNIQ','ID'=>$TaskID));
  #-----------------------------------------------------------------------------
  switch(ValueOf($Task)){
    case 'error':
      return ERROR | @Trigger_Error(500);
    case 'exception':
      return ERROR | @Trigger_Error(400);
    case 'array':
      #-------------------------------------------------------------------------
      $Config = Config();
      #-------------------------------------------------------------------------
      $Tasks = $Config['Tasks'];
      #-------------------------------------------------------------------------
      $IsUpdate = DB_Update('Tasks',Array('Errors'=>$Errors,'IsExecuted'=>$IsExecuted,'IsActive'=>$Tasks['Types'][$Task['TypeID']]['IsActive']),Array('ID'=>$Task['ID']));
      if(Is_Error($IsUpdate))
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
      return Array('Status'=>'Ok');
    default:
      return ERROR | @Trigger_Error(101);
  }
}else{
  #-----------------------------------------------------------------------------
  if(!$ExecuteDate)
    $ExecuteDate = Time();
  #-----------------------------------------------------------------------------
  $Config = Config();
  #-----------------------------------------------------------------------------
  $Types = $Config['Tasks']['Types'];
  #-----------------------------------------------------------------------------
  if(!IsSet($Types[$TypeID]))
    return new gException('WRONG_TASK_TYPE_ID','Неверный тип задания');
  #-----------------------------------------------------------------------------
  $Type = $Types[$TypeID];
  #-----------------------------------------------------------------------------
  $dParams = Array();
  #-----------------------------------------------------------------------------
  $ParamsIDs = Array_Keys($Type['Params']);
  #-----------------------------------------------------------------------------
  #Debug(SPrintF('[comp/www/Administrator/API/TaskEdit]: Params = %s',print_r($Params,true)));
  #-----------------------------------------------------------------------------
  for($i=0;$i<Count($ParamsIDs);$i++)
    $dParams[$ParamsIDs[$i]] = (IsSet($Params[$i])?$Params[$i]:'не определено');
  #-----------------------------------------------------------------------------
  $ITask = Array(
    #---------------------------------------------------------------------------
    'UserID'      => $UserID,
    'TypeID'      => $TypeID,
    'ExecuteDate' => $ExecuteDate,
    'Params'      => $dParams,
    'IsActive'    => $Type['IsActive']
  );
  #-----------------------------------------------------------------------------
  $TaskID = DB_Insert('Tasks',$ITask);
  if(Is_Error($TaskID))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  return Array('Status'=>'Ok','TaskID'=>$TaskID);
}
#-------------------------------------------------------------------------------

?>
