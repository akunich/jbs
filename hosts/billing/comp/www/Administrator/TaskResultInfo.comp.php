<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$TaskID = (integer) @$Args['TaskID'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','classes/DOM.class.php')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Task = DB_Select('Tasks','Result',Array('UNIQ','ID'=>$TaskID));
#-------------------------------------------------------------------------------
switch(ValueOf($Task)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    return ERROR | @Trigger_Error(400);
  case 'array':
    #---------------------------------------------------------------------------
    $Result = $Task['Result'];
    #---------------------------------------------------------------------------
    if(!$Result)
      return new gException('MANUAL_EXECUTION','Задание должно быть выполненно в ручную, либо активированно для автоматического выполнения');
    #---------------------------------------------------------------------------
    $DOM = new DOM();
    #---------------------------------------------------------------------------
    $Links = &Links();
    # Коллекция ссылок
    $Links['DOM'] = &$DOM;
    #---------------------------------------------------------------------------
    if(Is_Error($DOM->Load('Window')))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $DOM->AddText('Title','Результат выполнения задачи');
    #---------------------------------------------------------------------------
    $Actions = Preg_Split("(\n\r|\n)",$Result);
    #---------------------------------------------------------------------------
    for($i=0;$i<Count($Actions);$i++)
      $Actions[$i] = WordWrap(HtmlSpecialChars($Actions[$i]),120,"\n",TRUE);
    #---------------------------------------------------------------------------
    $DOM->AddChild('Into',new Tag('PRE',Array('class'=>'Script'),Implode("\n",$Actions)));
    #---------------------------------------------------------------------------
    if(Is_Error($DOM->Build(FALSE)))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    return Array('Status'=>'Ok','DOM'=>$DOM->Object);
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------

?>
