<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Error(System_Load('modules/Authorisation.mod','libs/Http.php')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
Header('Content-type: text/plain; charset=utf-8');
#-------------------------------------------------------------------------------
$Settings = Array('Host'=>HOST_ID,'Address'=>HOST_ID);
#-------------------------------------------------------------------------------
$__ADMINISTRATOR = $__CLIENT = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
echo "Авторизация в системе в качестве администратора\n";
#-------------------------------------------------------------------------------
$Args = Array(
  #-----------------------------------------------------------------------------
  'Email'    => 'admin@company.com',
  'Password' => 'default'
);
#-------------------------------------------------------------------------------
$Answer = Http_Send('/API/Logon',$Settings,$Args);
if(Is_Error($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Answer = @JSON_Decode($Answer['Body'],TRUE);
if(!Is_Array($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
switch($Answer['Status']){
  case 'Error':
    #---------------------------------------------------------------------------
    $Error = $Answer['Error'];
    #---------------------------------------------------------------------------
    return $Error['String'];
  case 'Exception':
    #---------------------------------------------------------------------------
    $Exception = $Answer['Exception'];
    #---------------------------------------------------------------------------
    return $Exception['String'];
  case 'Ok':
    $__ADMINISTRATOR['SessionID'] = $Answer['SessionID'];
  break;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
echo "OK\n";
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
echo "Поиск клиента\n";
#-------------------------------------------------------------------------------
$Args = Array(
  #-----------------------------------------------------------------------------
  'SessionID'    => $__ADMINISTRATOR['SessionID'],
  'TableID'      => 'Users',
  'Conditions[]' => 'Email=ivan@ivanov.ru',
  'ColumnsIDs[]' => 'ID'
);
#-------------------------------------------------------------------------------
$Answer = Http_Send('/Administrator/API/SelectDB',$Settings,$Args);
if(Is_Error($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Answer = @JSON_Decode($Answer['Body'],TRUE);
if(!Is_Array($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
switch($Answer['Status']){
  case 'Error':
    #---------------------------------------------------------------------------
    $Error = $Answer['Error'];
    #---------------------------------------------------------------------------
    return $Error['String'];
  case 'Exception':
    #---------------------------------------------------------------------------
    $Exception = $Answer['Exception'];
    #---------------------------------------------------------------------------
    return $Exception['String'];
  case 'Empty':
    return 'Клиент не найден';
  case 'Ok':
    #---------------------------------------------------------------------------
    $Row = Current($Answer['Rows']);
    #---------------------------------------------------------------------------
    $__CLIENT['ID'] = $Row['ID'];
  break;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
echo "OK\n";
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
echo "Поиск профилей клиента\n";
#-------------------------------------------------------------------------------
$Args = Array(
  #-----------------------------------------------------------------------------
  'SessionID'    => $__ADMINISTRATOR['SessionID'],
  'TableID'      => 'Profiles',
  'Conditions[]' => SPrintF('UserID=%u',$__CLIENT['ID']),
  'ColumnsIDs[]' => Array('ID','TemplateID','Name')
);
#-------------------------------------------------------------------------------
$Answer = Http_Send('/Administrator/API/SelectDB',$Settings,$Args);
if(Is_Error($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Answer = @JSON_Decode($Answer['Body'],TRUE);
if(!Is_Array($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
switch($Answer['Status']){
  case 'Error':
    #---------------------------------------------------------------------------
    $Error = $Answer['Error'];
    #---------------------------------------------------------------------------
    return $Error['String'];
  case 'Exception':
    #---------------------------------------------------------------------------
    $Exception = $Answer['Exception'];
    #---------------------------------------------------------------------------
    return $Exception['String'];
  case 'Empty':
    return 'Профили клиента не найдены';
  case 'Ok':
    $__CLIENT['Profiles'] = $Answer['Rows'];
  break;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
echo "OK\n";
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Folder = SPrintF('%s/tests/contracts',$Tmp);
#-------------------------------------------------------------------------------
if(!File_Exists($Folder)){
  #-----------------------------------------------------------------------------
  if(!@MkDir($Folder,0777,TRUE))
    return ERROR | @Trigger_Error(500);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
echo "Поиск профилей исполнителей\n";
#-------------------------------------------------------------------------------
$Args = Array(
  #-----------------------------------------------------------------------------
  'SessionID'    => $__ADMINISTRATOR['SessionID'],
  'TableID'      => 'Profiles',
  'Conditions[]' => 'UserID=100',
  'ColumnsIDs[]' => Array('ID','Name')
);
#-------------------------------------------------------------------------------
$Answer = Http_Send('/Administrator/API/SelectDB',$Settings,$Args);
if(Is_Error($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Answer = @JSON_Decode($Answer['Body'],TRUE);
if(!Is_Array($Answer))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
switch($Answer['Status']){
  case 'Error':
    #---------------------------------------------------------------------------
    $Error = $Answer['Error'];
    #---------------------------------------------------------------------------
    return $Error['String'];
  case 'Exception':
    #---------------------------------------------------------------------------
    $Exception = $Answer['Exception'];
    #---------------------------------------------------------------------------
    return $Exception['String'];
  case 'Empty':
    return 'Профиль исполнителя не найден';
  case 'Ok':
    $__ADMINISTRATOR['Profiles'] = $Answer['Rows'];
  break;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
echo "OK\n";
#-------------------------------------------------------------------------------
foreach($__ADMINISTRATOR['Profiles'] as $Executor){
  #-----------------------------------------------------------------------------
  if($Executor['ID'] != 100){
    #---------------------------------------------------------------------------
    echo SPrintF("Установка профиля исполнителя (%s)\n",$Executor['Name']);
    #---------------------------------------------------------------------------
    $Args = Array(
      #-------------------------------------------------------------------------
      'SessionID' => $__ADMINISTRATOR['SessionID'],
      'TableID'   => 'Profiles',
      'RowID'     => 100,
      'ID'        => Rand(100,999)
    );
    #---------------------------------------------------------------------------
    $Answer = Http_Send('/Administrator/API/RowEdit',$Settings,$Args);
    if(Is_Error($Answer))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Answer = @JSON_Decode($Answer['Body'],TRUE);
    if(!Is_Array($Answer))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    switch($Answer['Status']){
      case 'Error':
        #-----------------------------------------------------------------------
        $Error = $Answer['Error'];
        #-----------------------------------------------------------------------
        return $Error['String'];
      case 'Exception':
        #-----------------------------------------------------------------------
        $Exception = $Answer['Exception'];
        #-----------------------------------------------------------------------
        return $Exception['String'];
      case 'Ok':
        # No more...
      break;
      default:
        return ERROR | @Trigger_Error(101);
    }
    #---------------------------------------------------------------------------
    $Args = Array(
      #-------------------------------------------------------------------------
      'SessionID' => $__ADMINISTRATOR['SessionID'],
      'TableID'   => 'Profiles',
      'RowID'     => $Executor['ID'],
      'ID'        => 100
    );
    #---------------------------------------------------------------------------
    $Answer = Http_Send('/Administrator/API/RowEdit',$Settings,$Args);
    if(Is_Error($Answer))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Answer = @JSON_Decode($Answer['Body'],TRUE);
    if(!Is_Array($Answer))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    switch($Answer['Status']){
      case 'Error':
        #-----------------------------------------------------------------------
        $Error = $Answer['Error'];
        #-----------------------------------------------------------------------
        return $Error['String'];
      case 'Exception':
        #-----------------------------------------------------------------------
        $Exception = $Answer['Exception'];
        #-----------------------------------------------------------------------
        return $Exception['String'];
      case 'Ok':
        # No more...
      break;
      default:
        return ERROR | @Trigger_Error(101);
    }
    #---------------------------------------------------------------------------
    echo "OK\n";
  }
  #-----------------------------------------------------------------------------
  foreach($__CLIENT['Profiles'] as $Profile){
    #---------------------------------------------------------------------------
    echo SPrintF("Формирование договора %s\n",$Profile['Name']);
    #---------------------------------------------------------------------------
    $Args = Array(
      #-------------------------------------------------------------------------
      'SessionID' => $__ADMINISTRATOR['SessionID'],
      'TypeID'    => $Profile['TemplateID'],
      'ProfileID' => $Profile['ID']
    );
    #---------------------------------------------------------------------------
    $Answer = Http_Send('/API/ContractMake',$Settings,$Args);
    if(Is_Error($Answer))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Answer = @JSON_Decode($Answer['Body'],TRUE);
    if(!Is_Array($Answer))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    switch($Answer['Status']){
      case 'Error':
        #-----------------------------------------------------------------------
        $Error = $Answer['Error'];
        #-----------------------------------------------------------------------
        return $Error['String'];
      case 'Exception':
        #-----------------------------------------------------------------------
        $Exception = $Answer['Exception'];
        #-----------------------------------------------------------------------
        echo SPrintF("%s\n",$Exception['String']);
      continue 2;
      case 'Ok':
        #-----------------------------------------------------------------------
        echo "Загрузка договора\n";
        #-----------------------------------------------------------------------
        $Args = Array(
          #---------------------------------------------------------------------
          'SessionID'  => $__ADMINISTRATOR['SessionID'],
          'ContractID' => $Answer['ContractID']
        );
        #-----------------------------------------------------------------------
        $Answer = Http_Send('/ContractDownload',$Settings,$Args);
        if(Is_Error($Answer))
          return ERROR | @Trigger_Error(500);
        #-----------------------------------------------------------------------
        $Answer = @JSON_Decode($Answer['Body'],TRUE);
        if(!Is_Array($Answer))
          return ERROR | @Trigger_Error(500);
        #-----------------------------------------------------------------------
        switch($Answer['Status']){
          case 'Error':
            #-------------------------------------------------------------------
            $Error = $Answer['Error'];
            #-------------------------------------------------------------------
            return $Error['String'];
          case 'Exception':
            #-------------------------------------------------------------------
            $Exception = $Answer['Exception'];
            #-------------------------------------------------------------------
            return $Exception['String'];
          case 'Ok':
            #-------------------------------------------------------------------
            $Envelope = @File_Get_Contents(SPrintF('http://%s%s',$Settings['Address'],$Answer['Location']));
            if(!$Envelope)
              return 'Ошибка загрузки договора';
            #-------------------------------------------------------------------
            $IsWrite = IO_Write(SPrintF('%s/%s - %s.pdf',$Folder,$Executor['Name'],$Profile['Name']),$Envelope,TRUE);
            if(Is_Error($IsWrite))
              return ERROR | @Trigger_Error(500);
            #-------------------------------------------------------------------
          break;
          default:
            return ERROR | @Trigger_Error(101);
        }
        #-----------------------------------------------------------------------
        echo "OK\n";
      break;
      default:
        return ERROR | @Trigger_Error(101);
    }
  }
}
#-------------------------------------------------------------------------------

?>
