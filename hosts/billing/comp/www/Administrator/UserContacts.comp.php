<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$UserID = (integer) @$Args['UserID'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Messages = Messages();
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','classes/DOM.class.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Contacts = DB_Select('Contacts',Array('*'),Array('Where' => SPrintF('`UserID` = %s',$UserID)));
#-------------------------------------------------------------------------------
switch(ValueOf($Contacts)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'array':
	# No more...
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM = new DOM();
#-------------------------------------------------------------------------------
$Links = &Links();
# Коллекция ссылок
$Links['DOM'] = &$DOM;
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Load('Window')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddText('Title','Редактирование контактов пользователя');
#-------------------------------------------------------------------------------
$Table = Array('Контакты');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# шапка контактов
$Tr = new Tag('TR');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Formats/String','Тип контакта. Цветом обозначены неподтверждённые адреса',13);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Tr->AddChild(new Tag('TD',Array('class'=>'Head','align'=>'center'),$Comp));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tr->AddChild(new Tag('TD',Array('class'=>'Head','align'=>'center'),'Контакт'));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Formats/String','Логин для входа в биллинг',5);
if(Is_Error($Comp))
        return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Tr->AddChild(new Tag('TD',Array('class'=>'Head','align'=>'center'),$Comp));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Formats/String','Подтверждён',5);
if(Is_Error($Comp))
        return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Tr->AddChild(new Tag('TD',Array('class'=>'Head','align'=>'center'),$Comp));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Table[] = $Tr;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# перебираем контакты юзера, выводим их
#-------------------------------------------------------------------------------
$Methods = $Config['Notifies']['Methods'];
#-------------------------------------------------------------------------------
foreach($Contacts as $Contact){
	#-------------------------------------------------------------------------------
	$IsPrimary = Comp_Load('Form/Input',Array('type'=>'checkbox','name'=>'IsPrimary[]','value'=>$Contact['ID']));
	if(Is_Error($IsPrimary))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	if($Contact['IsPrimary'])
		$IsPrimary->AddAttribs(Array('checked'=>'yes'));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Confirmed = Comp_Load('Form/Input',Array('type'=>'checkbox','name'=>'Confirmed[]','value'=>$Contact['ID']));
	if(Is_Error($Confirmed))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	if($Contact['Confirmed'])
		$Confirmed->AddAttribs(Array('checked'=>'yes'));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// цвет бэкгроунда у типа адреса
	if($Contact['Confirmed'] == 1){
		#-------------------------------------------------------------------------------
		// контакт подтверждён администратором, не самим юзером
		$BgColor = 'Orange';
		#-------------------------------------------------------------------------------
	}elseif($Contact['Confirmed'] > 1){
		#-------------------------------------------------------------------------------
		// контакт подтверждён юзером
		$BgColor = '#D5F66C';
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		// контакт не подтверждён
		$BgColor = 'WhiteSmoke';
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Table[] = Array(
			#-------------------------------------------------------------------------------
			// тип контакта
			new Tag('TD',Array('class'=>'Head','style'=>SPrintF('background:%s;',$BgColor)),$Methods[$Contact['MethodID']]['Name']),
			#-------------------------------------------------------------------------------
			// адрес
			new Tag('TD',Array('class'=>'Head'),$Contact['Address']),
			#-------------------------------------------------------------------------------
			// это логин?
			new Tag('TD',Array('class'=>'Head'),$IsPrimary),
			#-------------------------------------------------------------------------------
			// подтверждён?
			new Tag('TD',Array('class'=>'Head'),$Confirmed),
			#-------------------------------------------------------------------------------

		);
        #-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Form/Input',Array('type'=>'button','onclick'=>"FormEdit('/Administrator/API/UserContacts','UserContactsEditForm','Сохранение настроек');",'value'=>'Сохранить'));
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Table[] = $Comp;
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Tables/Extended',$Table);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Form = new Tag('FORM',Array('name'=>'UserContactsEditForm','onsubmit'=>'return false;'),$Comp);
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Form/Input',Array('name'=>'UserID','value'=>$UserID,'type'=>'hidden'));
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Form->AddChild($Comp);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM->AddChild('Into',$Form);
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Build(FALSE)))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok','DOM'=>$DOM->Object);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
