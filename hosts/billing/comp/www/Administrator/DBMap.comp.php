<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Result = DB_Query('SHOW TABLE STATUS');
if(Is_Error($Result))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Tables = MySQL::Result($Result);
if(Is_Error($Tables))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$DbName = $Config['DBConnection']['DbName'];
#-------------------------------------------------------------------------------
$MainNode = new Tag('node',Array('TEXT'=>$DbName,'BACKGROUND_COLOR'=>'#ffff00'));
#-------------------------------------------------------------------------------
$MainNode->AddChild(new Tag('hook',Array('NAME'=>'accessories/plugins/AutomaticLayout.properties')));
#-------------------------------------------------------------------------------
$Node1 = new Tag('node',Array('TEXT'=>'Таблицы'));
#-------------------------------------------------------------------------------
$Node2 = new Tag('node',Array('TEXT'=>'Представления'));
#-------------------------------------------------------------------------------
foreach($Tables as $Table){
  #-----------------------------------------------------------------------------
  $TableID = $Table['Name'];
  #-----------------------------------------------------------------------------
  $TableNode = new Tag('node',Array('TEXT'=>$TableID,'FOLDED'=>'true'));
  #-----------------------------------------------------------------------------
  $Result = DB_Query(SPrintF('SHOW COLUMNS FROM `%s`',$TableID));
  if(Is_Error($Result))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  $Colomns = MySQL::Result($Result);
  if(Is_Error($Colomns))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  $Array = Array();
  #-----------------------------------------------------------------------------
  foreach($Colomns as $Colomn){
    #---------------------------------------------------------------------------
    $ColumnNode = new Tag('node',Array('TEXT'=>$Colomn['Field']));
    #---------------------------------------------------------------------------
    $ColumnNode->AddChild(new Tag('hook',Array('NAME'=>'accessories/plugins/NodeNote.properties'),new Tag('text',$Colomn['Type'])));
    #---------------------------------------------------------------------------
    $TableNode->AddChild($ColumnNode);
  }
  #-----------------------------------------------------------------------------
  ${$Table['Engine']?'Node1':'Node2'}->AddChild($TableNode);
}
#-------------------------------------------------------------------------------
$MainNode->AddChild($Node1);
$MainNode->AddChild($Node2);
#-------------------------------------------------------------------------------
$Map = new Tag('map',Array('version'=>'0.8.0'),$MainNode);
#-------------------------------------------------------------------------------
$Out = $Map->ToXMLString();
#-------------------------------------------------------------------------------
$Length = StrLen($Out);
#-------------------------------------------------------------------------------
Header('Content-Type: application/mm; charset=utf-8');
Header(SPrintF('Content-Length: %u',$Length));
Header('Content-Disposition: attachment; filename="DBMap.mm";');
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------

?>
