<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Notifies = $Config['Notifies'];
#-------------------------------------------------------------------------------
$Methods = $Notifies['Methods'];
#-------------------------------------------------------------------------------
foreach(Array_Keys($Methods) as $MethodID){
  #-----------------------------------------------------------------------------
  $Types = $Notifies['Types'];
  #-----------------------------------------------------------------------------
  foreach(Array_Keys($Types) as $TypeID){
    #---------------------------------------------------------------------------
    $Where = SPrintF("`UserID` = %u AND `MethodID` = '%s' AND `TypeID` = '%s'",$__USER['ID'],$MethodID,$TypeID);
    #---------------------------------------------------------------------------
    if(In_Array($TypeID,(array)@$Args[$MethodID])){
      #-------------------------------------------------------------------------
      $IsDelete = DB_Delete('Notifies',Array('Where'=>$Where));
      if(Is_Error($IsDelete))
        return ERROR | @Trigger_Error(500);
    }else{
      #-------------------------------------------------------------------------
      $Count = DB_Count('Notifies',Array('Where'=>$Where));
      if(Is_Error($Count))
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
      if(!$Count){
        #-----------------------------------------------------------------------
        $INotify = Array(
          #---------------------------------------------------------------------
          'UserID'   => $__USER['ID'],
          'MethodID' => $MethodID,
          'TypeID'   => $TypeID
        );
        #-----------------------------------------------------------------------
        $IsInsert = DB_Insert('Notifies',$INotify);
        if(Is_Error($IsInsert))
          return ERROR | @Trigger_Error(500);
      }
    }
  }
}
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------

?>
