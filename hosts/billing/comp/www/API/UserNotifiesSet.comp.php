<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$ContactID	= (integer) @$Args['ContactID'];
$MethodID	=  (string) @$Args['MethodID'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
foreach($GLOBALS['__USER']['Contacts'] as $iContact)
	if($iContact['ID'] == $ContactID)
		$Contact = $iContact;
#-------------------------------------------------------------------------------
if(!IsSet($Contact))
	return new gException('CONTACT_ID_NOT_FOUND',SPrintF('Неверно указан идентификатор контакта: %s',$ContactID));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Permission = Permission_Check('ContactRead',(integer)$GLOBALS['__USER']['ID'],(integer)$Contact['UserID']);
#---------------------------------------------------------------------------
switch(ValueOf($Permission)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'false':
	return ERROR | @Trigger_Error(700);
case 'true':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
# проверяем MethodID
$Methods = $Config['Notifies']['Methods'];
#-------------------------------------------------------------------------------
$Array = Array();
#-------------------------------------------------------------------------------
foreach(Array_Keys($Methods) as $Key)
	if($Methods[$Key]['IsActive'])
		$Array[] = $Key;
#-------------------------------------------------------------------------------
if(!In_Array($MethodID,$Array))
	return new gException('WRONG_CONTACT_METHOD','Неправильный или отключённый метод оповещения');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Notifies = $Config['Notifies'];
#-------------------------------------------------------------------------------
$Methods = $Notifies['Methods'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Types = $Notifies['Types'];
#-------------------------------------------------------------------------------
foreach(Array_Keys($Types) as $TypeID){
	#-------------------------------------------------------------------------------
	if(In_Array($TypeID,(array)@$Args[$MethodID])){
		#-------------------------------------------------------------------------------
		$IsDelete = DB_Delete('Notifies',Array('Where'=>SPrintF('`ContactID` = %u AND `TypeID` = "%s"',$ContactID,$TypeID)));
		if(Is_Error($IsDelete))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Count = DB_Count('Notifies',Array('Where'=>SPrintF('`ContactID` = %u AND `TypeID` = "%s"',$ContactID,$TypeID)));
		if(Is_Error($Count))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		if(!$Count){
			#-------------------------------------------------------------------------------
			$INotify = Array('ContactID'=>$ContactID,'TypeID'=>$TypeID);
			#-------------------------------------------------------------------------------
			$IsInsert = DB_Insert('Notifies',$INotify);
			if(Is_Error($IsInsert))
				return ERROR | @Trigger_Error(500);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
