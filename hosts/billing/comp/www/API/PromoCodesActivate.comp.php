<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Args = Args();
#-------------------------------------------------------------------------------
$Code		=  (string) @$Args['Code'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$Code)
	return new gException('NO_CODE','Введите ПромоКод');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Code = DB_Escape($Code);
#-------------------------------------------------------------------------------
$PromoCode = DB_Select('PromoCodes','*',Array('UNIQ','Where'=>SPrintF("`Code` = '%s'",$Code)));
#-------------------------------------------------------------------------------
switch(ValueOf($PromoCode)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return new gException('PROMOCODE_NOT_FOUND','Промокод не найден. Проверьте правильность ввода.');
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($PromoCode['ExpirationDate'] < Time())
	return new gException('PROMOCODE_EXPIRED','Срок действия промокода истёк');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($PromoCode['MaxAmount'] < $PromoCode['CurrentAmount'] + 1)
	return new gException('NO_FREE_PROMOCODES','Данные промокоды закончились');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Where = Array(
			SPrintF('`PromoCodeID` = %u',$PromoCode['ID']),
			SPrintF('`UserID` = %u',$GLOBALS['__USER']['ID'])
		);
#-------------------------------------------------------------------------------
$Count = DB_Count('PromoCodesExtinguished',Array('Where'=>$Where));
if(Is_Error($Count))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if($Count)
	return new gException('PROMOCODE_ALREADY_EXTINGUISHED','Промокод уже был использован');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$ICode = Array(
		'PromoCodeID'	=> $PromoCode['ID'],
		'UserID'	=> $GLOBALS['__USER']['ID'],
		'CreateDate'	=> Time()
);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IBonus = Array(
		'UserID'	=> $GLOBALS['__USER']['ID'],
		'ServiceID'	=> $PromoCode['ServiceID'],
		'SchemeID'	=> $PromoCode['SchemeID'],
		'SchemesGroupID'=> $PromoCode['SchemesGroupID'],
		'DaysReserved'	=> $PromoCode['DaysDiscont'],
		'Discont'	=> $PromoCode['Discont'],
		'Comment'	=> SPrintF('Активация промокода "%s"',$Code)
);
#-------------------------------------------------------------------------------
#-------------------------------TRANSACTION-------------------------------------
if(Is_Error(DB_Transaction($TransactionID = UniqID('PromoCodesExtinguished'))))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsInsert = DB_Insert('PromoCodesExtinguished',$ICode);
if(Is_Error($IsInsert))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsInsert = DB_Insert('Bonuses',$IBonus);
if(Is_Error($IsInsert))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Count = DB_Count('PromoCodesExtinguished',Array('Where'=>SPrintF('`PromoCodeID` = %u',$PromoCode['ID'])));
if(Is_Error($Count))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$IsUpdate = DB_Update('PromoCodes',Array('CurrentAmount'=>$Count),Array('ID'=>$PromoCode['ID']));
if(Is_Error($IsUpdate))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Is_Error(DB_Commit($TransactionID)))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------

?>
