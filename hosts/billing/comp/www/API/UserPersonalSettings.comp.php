<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','classes/Session.class.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Template = System_XML('xml/Params/Users.xml');
if(Is_Error($Template))
	return new gException('ERROR_TEMPLATE_LOAD','Ошибка загрузки шаблона');
#-------------------------------------------------------------------------------
$Errors = $Attribs = Array();
#-------------------------------------------------------------------------------
# TODO выпилить хреновину в отдельный файл
$AttribsName = 'Settings';      # Attribs
#-------------------------------------------------------------------------------
if(IsSet($Template[$AttribsName])){
	#-------------------------------------------------------------------------------
	$Params = $Template[$AttribsName];
	#-------------------------------------------------------------------------------
	$Regulars = Regulars();
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Params) as $AttribID){
		#-------------------------------------------------------------------------------
		$Attrib = $Params[$AttribID];
		#-------------------------------------------------------------------------------
		$Value = (IsSet($Args[$AttribID])?$Args[$AttribID]:$Params[$AttribID]['Value']);
		#-------------------------------------------------------------------------------
		# костыль для чекбоксов
		if(IsSet($Attrib['Attribs']['type']) && $Attrib['Attribs']['type'] == 'checkbox')
			$Value = (boolean) @$Args[$AttribID];
		#-------------------------------------------------------------------------------
		$Attribs[$AttribID] = $Value;
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		switch($Attrib['Type']){
		case 'Input':
			# No more...
		case 'Hidden':
			# No more...
		case 'TextArea':
			#-------------------------------------------------------------------------------
			if($Value){
				#-------------------------------------------------------------------------------
				$Check = $Attrib['Check'];
				#-------------------------------------------------------------------------------
				if(IsSet($Regulars[$Check]))
					$Check = $Regulars[$Check];
				#-------------------------------------------------------------------------------
				if(!Preg_Match($Check,$Value)){
					#-------------------------------------------------------------------------------
					$Errors[] = $AttribID;
					#-------------------------------------------------------------------------------
					Debug(SPrintF('[comp/www/API/UserPersonalSettings]: Check = %s; Value = %s',$Check,$Value));
					#-------------------------------------------------------------------------------
				}
				#-------------------------------------------------------------------------------
			}else{
				#-------------------------------------------------------------------------------
				if($Attrib['IsDuty'])
					$Errors[] = $AttribID;
				#-------------------------------------------------------------------------------
			}       
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		case 'Select':
			#-------------------------------------------------------------------------------
			if(!IsSet($Attrib['Options'][$Value]))
				$Errors[] = $AttribID;
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(100);
		}       
		#-------------------------------------------------------------------------------
	}       
	#-------------------------------------------------------------------------------
}       
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Count($Errors)){
	#-------------------------------------------------------------------------------
	$Attribs = $Template['Attribs'];
	#-------------------------------------------------------------------------------
	$Parent = NULL;
	#-------------------------------------------------------------------------------
	$Errors = Array_Reverse($Errors);
	#-------------------------------------------------------------------------------
	foreach($Errors as $AttribID){
		#-------------------------------------------------------------------------------
		$Attrib = $Attribs[$AttribID];
		#-------------------------------------------------------------------------------
		$Exception = new gException(StrToUpper($AttribID),$Attrib['Comment'],$Parent);
		#-------------------------------------------------------------------------------
		$Parent = $Exception;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(IsSet($Exception))
		return new gException('FIELDS_WRONG_FILLED','Неверно заполнены поля',$Exception);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
$Replace = Array_ToLine($Attribs,'%');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$Settings = $__USER['Params'];
#-------------------------------------------------------------------------------
# удаляем старые настройки
if(IsSet($__USER['Params']['Settings']))
	UnSet($__USER['Params']['Settings']);
#-------------------------------------------------------------------------------
# добавляем новые настройки
$__USER['Params']['Settings'] = $Attribs;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsUpdate = DB_Update('Users',Array('Params'=>$__USER['Params']),Array('ID'=>$__USER['ID']));
if(Is_Error($IsUpdate))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
