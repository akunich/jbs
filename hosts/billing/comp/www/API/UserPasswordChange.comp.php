<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Password	= (string) @$Args['Password'];
$UserID		= (integer)@$Args['UserID'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($UserID && !$GLOBALS['__USER']['IsAdmin'])
	return ERROR | @Trigger_Error(700);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
if(!Preg_Match($Regulars['Password'],$Password))
	return new gException('WRONG_PASSWORD','Неверно указан новый пароль');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$User = DB_Select('Users','ID',Array('UNIQ','ID'=>(($UserID)?$UserID:$GLOBALS['__USER']['ID'])));
#-------------------------------------------------------------------------------
switch(ValueOf($User)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
$UserID = (integer)$User['ID'];
#-------------------------------------------------------------------------------
$IsUpdate = DB_Update('Users',Array('Watchword'=>Md5($Password),'UniqID'=>Md5(SPrintF('%s.%s,',UniqID(),Rand(0,1000000)))),Array('ID'=>$UserID));
if(Is_Error($IsUpdate))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Path = SPrintF('%s/sessions',$Tmp);
#-------------------------------------------------------------------------------
if(File_Exists($Path)){
	#-------------------------------------------------------------------------------
	$SessionIDsIDs = IO_Scan($Path);
	if(Is_Error($SessionIDsIDs))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	foreach($SessionIDsIDs as $SessionID){
		#-------------------------------------------------------------------------------
		if(@$_COOKIE['SessionID'] != $SessionID){
			#-------------------------------------------------------------------------------
			if(Preg_Match(SPrintF('/^(REMEBMER|SESSION)%s/',MD5($UserID)),$SessionID)){
				#-------------------------------------------------------------------------------
				if(!@UnLink(SPrintF('%s/%s',$Path,$SessionID)))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
