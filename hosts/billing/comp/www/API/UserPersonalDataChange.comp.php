<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$Name		=  (string) @$Args['Name'];
$Sign		=  (string) @$Args['Sign'];
$IsClear	= (boolean) @$Args['IsClear'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','libs/Upload.php','libs/Image.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
if(!Preg_Match($Regulars['UserName'],$Name))
	return new gException('WRONG_USER_NAME','Вы ввели неверное имя');
#-------------------------------------------------------------------------------
if(!$Sign)
	return new gException('SIGN_IS_EMPTY','Укажите Вашу подпись');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$UUser = Array('Name'=>$Name,'Sign'=>$Sign,'Params'=>$__USER['Params']);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Upload = Upload_Get('UserFoto');
#-------------------------------------------------------------------------------
switch(ValueOf($Upload)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	break;
case 'array':
	#-------------------------------------------------------------------------------
	$Foto = $Upload['Data'];
	#-------------------------------------------------------------------------------
	$Foto = Image_Resize($Foto,90,110);
	#-------------------------------------------------------------------------------
	if(Is_Error($Foto))
		return new gException('FOTO_RESIZE_ERROR','Ошибка изменения размеров персональной фотографии');
	#-------------------------------------------------------------------------------
	if(!SaveUploadedFile('Users',$__USER['ID'],$Foto))
		return new gException('CANNOT_SAVE_UPLOADED_FILE','Не удалось сохранить загруженный файл');
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
if($IsClear)
	if(!DeleteUploadedFile('Users',$__USER['ID']))
		return new gException('CANNOT_DELETE_FILE','Не удалось удалить связанный файл');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsUpdate = DB_Update('Users',$UUser,Array('ID'=>$__USER['ID']));
if(Is_Error($IsUpdate))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# исправляем юзера, на всякий случай
$Comp = Comp_Load('Tasks/RecoveryUsers',NULL,$__USER['ID']);
#-------------------------------------------------------------------------------
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
