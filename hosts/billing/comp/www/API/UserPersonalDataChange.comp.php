<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$Name    =  (string) @$Args['Name'];
$Sign    =  (string) @$Args['Sign'];
$Email   =  (string) @$Args['Email'];
$ICQ     =  (string) @$Args['ICQ'];
$Jabber  = (string) @$Args['Jabber'];
$JabberID=  (string) @$Args['JabberID'];

$SMS  =  (string) @$Args['SMS'];
$IsClear = (boolean) @$Args['IsClear'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------




# tmp 
if(!$JabberID && $Jabber)
	$JabberID = $Jabber;




$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$CacheID2 = Md5(SPrintF('SMSConfirm_%s',$__USER['ID']));
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','libs/Upload.php','libs/Image.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
if(!Preg_Match($Regulars['Char'],$Name))
	return new gException('WRONG_NAME','Вы ввели неверное имя');
#-------------------------------------------------------------------------------
if(!$Sign)
	return new gException('SIGN_IS_EMPTY','Укажите Вашу подпись');
#-------------------------------------------------------------------------------
$Email = StrToLower($Email);
#-------------------------------------------------------------------------------
if(!Preg_Match($Regulars['Email'],$Email))
	return new gException('WRONG_EMAIL','Неверно указан электронный адрес');
#-------------------------------------------------------------------------------
$User = DB_Select('Users',Array('ID','Email','Params'),Array('UNIQ','ID'=>$__USER['ID'])); 
#-------------------------------------------------------------------------------
switch(ValueOf($User)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
if(StrToLower($User['Email']) != $Email){
	#-------------------------------------------------------------------------------
	$Count = DB_Count('Users',Array('Where'=>SPrintF("`Email` = '%s'",$Email)));
	if(Is_Error($Count))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	if($Count)
		return new gException('USER_EXISTS','Пользователь с таким электронным адресом уже существует в системе');
	#-------------------------------------------------------------------------------
	if($GLOBALS['__USER']['EmailConfirmed'] + 3600 < Time())
		if(Time() - $__USER['RegisterDate'] > 24*3600)
			return new gException('EMAIL_CONFIRM_TOO_OLD','Вы слишком давно подтверждали ваш почтовый адрес. Смена адреса возможна в течение часа после его подтверждения.');
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($ICQ){
	#-------------------------------------------------------------------------------
	if(!Preg_Match($Regulars['ICQ'],$ICQ))
		return new gException('WRONG_ICQ','Неверно указан ICQ-номер');
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($JabberID){
	#-------------------------------------------------------------------------------
	$JabberID = StrToLower($JabberID);
	#-------------------------------------------------------------------------------
	if(!Preg_Match($Regulars['Email'],$JabberID))
		return new gException('WRONG_JabberID','Неверно указан Jabber ID');
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($SMS){
	#-------------------------------------------------------------------------------
	if(!Preg_Match($Regulars['SMS'],$SMS))
		return new gException('WRONG_MOBILE','Номер мобильного телефона указан неверно');
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Params = $User['Params'];
#-------------------------------------------------------------------------------
$Params['NotificationMethods']['Jabber']['Address'] = $JabberID;
#-------------------------------------------------------------------------------
$Params['NotificationMethods']['ICQ']['Address'] = $ICQ;
#-------------------------------------------------------------------------------
$Params['NotificationMethods']['SMS']['Address'] = $SMS;
#-------------------------------------------------------------------------------
if($User['Params']['NotificationMethods']['SMS']['Address'] != $SMS){
	#-------------------------------------------------------------------------------
	$Params['NotificationMethods']['SMS']['Confirmed'] = 0;
	#-------------------------------------------------------------------------------
	CacheManager::add($CacheID2, '0');
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$UUser = Array(
		'Name'		=> $Name,
		'Sign'		=> $Sign,
		'Email'		=> $Email,
		'Params'	=> $Params
		);
#-------------------------------------------------------------------------------
if($User['Email'] != $Email)
	$UUser['EmailConfirmed'] = 0;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Upload = Upload_Get('UserFoto');
#-------------------------------------------------------------------------------
switch(ValueOf($Upload)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	break;
case 'array':
	#-------------------------------------------------------------------------------
	$Foto = $Upload['Data'];
	#-------------------------------------------------------------------------------
	$Foto = Image_Resize($Foto,90,110);
	#-------------------------------------------------------------------------------
	if(Is_Error($Foto))
		return new gException('FOTO_RESIZE_ERROR','Ошибка изменения размеров персональной фотографии');
	#-------------------------------------------------------------------------------
	if(!SaveUploadedFile('Users', $User['ID'], $Foto))
		return new gException('CANNOT_SAVE_UPLOADED_FILE','Не удалось сохранить загруженный файл');
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
if($IsClear)
	if(!DeleteUploadedFile('Users',$User['ID']))
		return new gException('CANNOT_DELETE_FILE','Не удалось удалить связанный файл');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsUpdate = DB_Update('Users',$UUser,Array('ID'=>$User['ID']));
if(Is_Error($IsUpdate))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($User['Email'] != $Email){
	#-------------------------------------------------------------------------------
	$Event = Array(
			'UserID'	=> $__USER['ID'],
			'PriorityID'	=> 'Billing',
			'Text'		=> SPrintF('Пользователь сменил свой почтовый адрес с (%s) на (%s)',$User['Email'],$Email)
			);
	$Event = Comp_Load('Events/EventInsert',$Event);
	if(!$Event)
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($User['Params']['NotificationMethods']['SMS']['Address'] != $SMS){
	#-------------------------------------------------------------------------------
	$Message = ($User['Params']['NotificationMethods']['SMS']['Address'])?SPrintF('Смена контактного телефона %s -> %s',$User['Params']['NotificationMethods']['SMS']['Address'],$SMS):SPrintF('Добавлен контактный телефон (%s)',$SMS);
	#-------------------------------------------------------------------------------
	$Message = ($SMS)?$Message:SPrintF('Удалён контактный телефон (%s)',$User['Params']['NotificationMethods']['SMS']['Address']);
	#-------------------------------------------------------------------------------
	$Event = Array(
			'UserID'	=> $__USER['ID'],
			'PriorityID'	=> 'Billing',
			'Text'		=> $Message
			);
	#-------------------------------------------------------------------------------
	$Event = Comp_Load('Events/EventInsert', $Event);
	if(!$Event)
		return ERROR | @Trigger_Error(500);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
