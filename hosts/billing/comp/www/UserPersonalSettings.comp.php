<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Error(System_Load('modules/Authorisation.mod','classes/DOM.class.php','libs/Upload.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM = new DOM();
#-------------------------------------------------------------------------------
$Links = &Links();
# Коллекция ссылок
$Links['DOM'] = &$DOM;
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Load('Window')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddText('Title','Персональные настройки');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$Settings = $__USER['Params'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Template = System_XML('xml/Params/Users.xml');
if(Is_Error($Template))
	return new gException('ERROR_TEMPLATE_LOAD','Ошибка загрузки шаблона');
#-------------------------------------------------------------------------------
$Table = Array();
#-------------------------------------------------------------------------------
# TODO попробовать выпилить в отдельный компонет код по разбору xml 
$AttribsName = 'Settings';	# Attribs
$DataID = $__USER;		# $ServerID
#Debug(print_r($DataID,true));
#-------------------------------------------------------------------------------
if(IsSet($Template[$AttribsName])){
	#-------------------------------------------------------------------------------
	$Attribs = $Template[$AttribsName];
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Replace = Array_ToLine($__USER,'%');
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Attribs) as $AttribID){
		#-------------------------------------------------------------------------------
		$Attrib = $Attribs[$AttribID];
		#-------------------------------------------------------------------------------
		if(IsSet($Attrib['Title']))
			$Table[] = $Attrib['Title'];
		#-------------------------------------------------------------------------------
		if($DataID){
			#-------------------------------------------------------------------------------
			$Value = (string)@$DataID['Params'][$AttribsName][$AttribID];
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			$Value = $Attrib['Value'];
			#-------------------------------------------------------------------------------
			foreach(Array_Keys($Replace) as $Key)
				$Value = Str_Replace($Key,$Replace[$Key],$Value);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$Params = &$Attrib['Attribs'];
		#-------------------------------------------------------------------------------
		$Params['name'] = $AttribID;
		#-------------------------------------------------------------------------------
		if($Attrib['IsDuty'])
			$Params['class'] = 'Duty';
		#-------------------------------------------------------------------------------
		switch($Attrib['Type']){
		case 'Input':
			#-------------------------------------------------------------------------------
			$Params['value'] = $Value;
			#-------------------------------------------------------------------------------
			# костыль для чекбоксов - у них всегда одно значение
			if(IsSet($Attrib['Attribs']['type']) && $Attrib['Attribs']['type'] == 'checkbox')
				$Params['value'] = 'yes';
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/Input',$Params);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			# костыль для чекбоксов - у них дополнительный параметр "checked", если задано значение
			if(IsSet($Attrib['Attribs']['type']) && $Attrib['Attribs']['type'] == 'checkbox' && $Value)
				$Comp->AddAttribs(Array('checked'=>'yes'));
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		case 'TextArea':
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/TextArea',$Params,$Value);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		case 'Select':
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/Select',$Params,$Attrib['Options'],$Value);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		case 'Hidden':
			#-------------------------------------------------------------------------------
			$Params['value'] = $Value;
			#-------------------------------------------------------------------------------
			$Params['type'] = 'hidden';
			#-------------------------------------------------------------------------------
			$Comp = Comp_Load('Form/Input',$Params);
			if(Is_Error($Comp))
				return ERROR | @Trigger_Error(101);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		if($Attrib['Type'] == 'Hidden'){
			#-------------------------------------------------------------------------------
			$Form->AddChild($Comp);
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			$NoBody = new Tag('NOBODY',new Tag('SPAN',(IsSet($Attrib['CommentAttribs'])?$Attrib['CommentAttribs']:Array()),$Attrib['Comment']));
			#-------------------------------------------------------------------------------
			$NoBody->AddChild(new Tag('BR'));
			#-------------------------------------------------------------------------------
			if(IsSet($Attrib['Example']))
				$NoBody->AddChild(new Tag('SPAN',Array('class'=>'Comment'),SPrintF('Например: %s',$Attrib['Example'])));
			#-------------------------------------------------------------------------------
			$Table[] = Array($NoBody,$Comp);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Form/Input',Array('type'=>'button','onclick'=>"FormEdit('/API/UserPersonalSettings','UserPersonalSettingsForm','Сохранение ваших персональных настроек');",'value'=>'Сохранить'));
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Table[] = $Comp;
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Tables/Standard',$Table);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Tab','User/Settings',new Tag('FORM',Array('name'=>'UserPersonalSettingsForm','onsubmit'=>'return false;'),$Comp));
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddChild('Into',$Comp);
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Build(FALSE)))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok','DOM'=>$DOM->Object);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
