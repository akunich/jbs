<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$ImageID = (integer) @$Args['ImageID'];
$Width   = (integer) @$Args['Width'];
$Height  = (integer) @$Args['Height'];
$Scale   = (integer) @$Args['Scale'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('libs/Image.php')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Image = DB_Select('ClausesFiles',Array('FileName','FileData'),Array('UNIQ','ID'=>$ImageID));
#-------------------------------------------------------------------------------
switch(ValueOf($Image)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    return ERROR | @Trigger_Error(400);
  case 'array':
    #---------------------------------------------------------------------------
    $Image = $Image['FileData'];
    #---------------------------------------------------------------------------
    $Size = Image_Get_Size($Image);
    if(Is_Error($Size))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Index = $Size['Height']/$Size['Width'];
    #---------------------------------------------------------------------------
    if($Width){
      #-------------------------------------------------------------------------
      $Height = $Width*$Index;
      #-------------------------------------------------------------------------
      $Image = Image_Resize($Image,(integer)$Width,(integer)$Height);
      if(Is_Error($Image))
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
    }elseif($Height){
      #-------------------------------------------------------------------------
      $Width = $Height/$Index;
      #-------------------------------------------------------------------------
      $Image = Image_Resize($Image,(integer)$Width,(integer)$Height);
      if(Is_Error($Image))
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
    }elseif($Scale != 100){
      #-------------------------------------------------------------------------
      $Scale = Min(Max(50,$Scale),200);
      #-------------------------------------------------------------------------
      $Width  = $Size['Width']*($Scale/100);
      $Height = $Width*$Index;
      #-------------------------------------------------------------------------
      $Image = Image_Resize($Image,(integer)$Width,(integer)$Height);
      if(Is_Error($Image))
        return ERROR | @Trigger_Error(500);
    }
    #---------------------------------------------------------------------------
    Header('Content-Type: image');
    Header('Cache-Control: private, max-age=86400');
    #---------------------------------------------------------------------------
    return $Image;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------

?>
