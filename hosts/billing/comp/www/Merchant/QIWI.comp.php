<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$Wsdl = System_Element('config/Wsdl/IShopClientWS.wsdl');
#-------------------------------------------------------------------------------
if(Is_Error($Wsdl))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$s = new SoapServer($Wsdl, array('classmap' => array('tns:updateBill' => 'Param', 'tns:updateBillResponse' => 'Response')));
$s->setClass('TestServer');
$s->handle();
#-------------------------------------------------------------------------------
class Response {
	public $updateBillResult;
}
#-------------------------------------------------------------------------------
class Param {
	public $login;
	public $password;
	public $txn;      
	public $status;
}
#-------------------------------------------------------------------------------
class TestServer {
	#-------------------------------------------------------------------------------
	function updateBill($param){
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[comp/www/Merchant/QIWI]: login = %s; password = %s; txn = %s, status = %s',$param->login,$param->password,$param->txn,$param->status));
		Debug(SPrintF('[comp/www/Merchant/QIWI]: param = %s',print_r($param,true)));
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$Out = new Response();
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$Config = Config();
		#-------------------------------------------------------------------------------
		$Settings = $Config['Invoices']['PaymentSystems']['QIWI'];
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$LocalHash = StrToUpper(Md5($param->txn . StrToUpper(md5($Settings['Hash']))));
		#-------------------------------------------------------------------------------
		if($LocalHash == $param->password){
			#-------------------------------------------------------------------------------
			# пасс совпал

			# ввиду того что сумма не приходит,дальнейшее не имеет смысла - нельзя проверить, может оплачивают рупь, а проведём 100 тыщщ...
			$Out->updateBillResult = 0;
			return $Out;
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			# проверяем наличие такого счёта
			$Invoice = DB_Select('Invoices',Array('ID','Summ'),Array('UNIQ','ID'=>IntVal($param->txn)));
			#-------------------------------------------------------------------------------
			switch(ValueOf($Invoice)){
			case 'error':
				return ERROR | @Trigger_Error(500);
			case 'exception':
				#-------------------------------------------------------------------------------
				$Out->updateBillResult = 210;
				return $Out;
				#-------------------------------------------------------------------------------
			case 'array':
				break;
			default:
				return ERROR | @Trigger_Error(101);
			}
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			# пасс не совпал
			Debug(SPrintF('[comp/www/Merchant/QIWI]: Не совпадает хэш LocalHash = %s; password = %s',$LocalHash,$param->password));
			$Out->updateBillResult = 150;
			#-------------------------------------------------------------------------------
		}


		return $Out;


#		$temp = new Response();
#		$temp->updateBillResult = 0;
		
	
#		return $temp;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
