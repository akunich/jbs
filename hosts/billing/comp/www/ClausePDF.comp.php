<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$ClauseID = (string) @$Args['ClauseID'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('classes/DOM.class','libs/HTMLDoc.php')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Clauses/Load',$ClauseID);
if(Is_Error($Comp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM = new DOM();
#-------------------------------------------------------------------------------
$Links = &Links();
# Коллекция ссылок
$Links['DOM'] = &$DOM;
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Load('Standard')))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddText('Title',$Title = $Comp['Title']);
#-------------------------------------------------------------------------------
$DOM->AddChild('Into',$Comp['DOM']);
#-------------------------------------------------------------------------------
$DOM->Delete('ClauseTrash');
#-------------------------------------------------------------------------------
$Out = $DOM->Build();
if(Is_Error($Out))
 return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$PDF = HTMLDoc_CreatePDF('Clause',$Out);
#-------------------------------------------------------------------------------
switch(ValueOf($PDF)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    return ERROR | @Trigger_Error(400);
  case 'string':
    #---------------------------------------------------------------------------
    $Tmp = System_Element('tmp');
    if(Is_Error($Tmp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $File = SPrintF('Clause%s.pdf',Md5($_SERVER['REMOTE_ADDR']));
    #---------------------------------------------------------------------------
    $IsWrite = IO_Write(SPrintF('%s/files/%s',$Tmp,$File),$PDF,TRUE);
    if(Is_Error($IsWrite))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    return Array('Status'=>'Ok','Location'=>SPrintF('/GetTemp?File=%s&Name=%s.pdf&Mime=application/pdf',$File,UrlEncode($Title)));
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------

?>
