<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('ServiceOrderID','ServiceID','ServiceCode','IsNotFound');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
#Debug(SPrintF('[Services/Orders/SearchOrderID]: ServiceOrderID = %s; ServiceID = %s; ServiceCode = %s; IsNotFound = %s',$ServiceOrderID,$ServiceID,$ServiceCode,print_r($IsNotFound,true)));
if(!$ServiceOrderID)
	return ERROR | @Trigger_Error(401);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($ServiceCode == 'Default')
	return $ServiceOrderID;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$CacheID = Md5(SPrintF('%s-%s-%s-%s',$__FILE__,$ServiceOrderID,($ServiceID)?$ServiceID:'ServiceID',($ServiceCode)?$ServiceCode:'ServiceCode'));
#-------------------------------------------------------------------------------
$Result = CacheManager::get($CacheID);
if($Result)
	return $Result;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$ServiceCode){
	#-------------------------------------------------------------------------------
	$Service = DB_Select('ServicesOwners','Code',Array('UNIQ','ID'=>$ServiceID));
	switch(ValueOf($Service)){
	case 'error':
		return ERROR | @Trigger_Error(500);
	case 'exception':
		return ERROR | @Trigger_Error(400);
	case 'array':
		#-------------------------------------------------------------------------------
		$ServiceCode = $Service['Code'];
		#-------------------------------------------------------------------------------
		break;
		#-------------------------------------------------------------------------------
	default:
		return ERROR | @Trigger_Error(101);
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Order = DB_Select(SPrintF('%sOrdersOwners',$ServiceCode),'OrderID',Array('UNIQ','ID'=>$ServiceOrderID));
#-------------------------------------------------------------------------------
switch(ValueOf($Order)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	#-------------------------------------------------------------------------------
	if($IsNotFound)
		return "00000";
	#-------------------------------------------------------------------------------
	return ERROR | @Trigger_Error(400);
	#-------------------------------------------------------------------------------
case 'array':
	#-------------------------------------------------------------------------------
	CacheManager::add($CacheID,$Order['OrderID'],24*3600);
	#-------------------------------------------------------------------------------
	return $Order['OrderID'];
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
