<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Logs = SPrintF('%s/logs',$Tmp);
#-------------------------------------------------------------------------------
if(File_Exists($Logs)){
  #-----------------------------------------------------------------------------
  $Files = IO_Scan($Logs);
  if(Is_Error($Files))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  foreach($Files as $Log){
    #---------------------------------------------------------------------------
    $Path = SPrintF('%s/%s',$Logs,$Log);
    #---------------------------------------------------------------------------
    if(Preg_Match('/^.+\.log+$/',$Log)){
      #-------------------------------------------------------------------------
      if(FileSize($Path) > 1048576){
        #-----------------------------------------------------------------------
        $Time = Date('[d.m.Y]');
        #-----------------------------------------------------------------------
        if(!ReName($Path,SPrintF('%s/%s%s',$Logs,$Log,$Time)))
          return ERROR | @Trigger_Error(SPrintF('[comp/Tasks/Logs]: не удалось произвести ротацию лога (%s)',$Path));
      }
    }else{
      #-------------------------------------------------------------------------
      if(Time() - FileMTime($Path) > 604800){
        #-----------------------------------------------------------------------
        if(!@UnLink($Path))
          return ERROR | @Trigger_Error(SPrintF('[comp/Tasks/Logs]: не удалось удалить устаревший лог (%s)',$Path));
      }
    }
  }
}
#-------------------------------------------------------------------------------
return 86400;
#-------------------------------------------------------------------------------

?>
