<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Task');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Count = DB_Count('Profiles');
if(Is_Error($Count))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if($Count){
	#-------------------------------------------------------------------------------
	for($i=0;$i<$Count;$i+=10){
		#-------------------------------------------------------------------------------
		$Profiles = DB_Select('Profiles',Array('ID','TemplateID','Attribs'),Array('Limits'=>Array('Start'=>$i,'Length'=>10)));
		#-------------------------------------------------------------------------------
		switch(ValueOf($Profiles)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			# No more...
			break;
		case 'array':
			#-------------------------------------------------------------------------------
			foreach($Profiles as $Profile){
				#-------------------------------------------------------------------------------
				$Attribs = $Profile['Attribs'];
				#-------------------------------------------------------------------------------
				$Template = System_XML(SPrintF('profiles/%s.xml',$Profile['TemplateID']));
				if(Is_Error($Template))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
				foreach(Array_Keys($Template['Attribs']) as $AttribID)
					if(!IsSet($Attribs[$AttribID]))
						$Attribs[$AttribID] = $Template['Attribs'][$AttribID]['Value'];
				#-------------------------------------------------------------------------------
				foreach(Array_Keys($Attribs) as $AttribID)
					if(!IsSet($Template['Attribs'][$AttribID]))
						UnSet($Attribs[$AttribID]);
				#-------------------------------------------------------------------------------
				$IsUpdate = DB_Update('Profiles',Array('Attribs'=>$Attribs),Array('ID'=>$Profile['ID']));
				if(Is_Error($IsUpdate))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
        $Event = Array(
			'UserID'        => 100,
			'PriorityID'    => 'Billing',
			'Text'          => SPrintF('Успешно восстановлено #%u профилей',$Count)
			);
	$Event = Comp_Load('Events/EventInsert',$Event);
	if(!$Event)
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$GLOBALS['TaskReturnInfo'] = SPrintF('Recovered: %u profiles',$Count);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(IsSet($GLOBALS['IsCron']))
	return TRUE;
#-------------------------------------------------------------------------------
return $Count;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
