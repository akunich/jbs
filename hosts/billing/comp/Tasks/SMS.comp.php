<?php
#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Task', 'Mobile', 'Message', 'ID');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
Debug(SPrintF('[comp/Tasks/SMS]: отправка SMS сообщения для (%u)', $Mobile));
#-------------------------------------------------------------------------------
$GLOBALS['TaskReturnInfo'] = $Mobile;
#-------------------------------------------------------------------------------
if (Is_Error(System_Load('classes/SMSC.class.php')))
    return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['SMSC'];
#-------------------------------------------------------------------------------
$Links = &Links();
#-------------------------------------------------------------------------------
$LinkID = Md5('SMSC');
#-------------------------------------------------------------------------------
if (!IsSet($Links[$LinkID])) {
    #-----------------------------------------------------------------------------
    $Links[$LinkID] = NULL;
    #-----------------------------------------------------------------------------
    $SMSC = &$Links[$LinkID];
    #-----------------------------------------------------------------------------
    $SMSC = new SMSC();
    if (Is_Error($SMSC))
        return ERROR | @Trigger_Error(500);
}
#-------------------------------------------------------------------------------
$SMSC = &$Links[$LinkID];
#-------------------------------------------------------------------------------
$Message = Mb_Convert_Encoding($Message, $Settings['Charset']);
#-------------------------------------------------------------------------------
$IsMessage = $SMSC->sendSms($Mobile, $Message);
if (Is_Error($IsMessage)) {
    #-----------------------------------------------------------------------------
    UnSet($Links[$LinkID]);
    #-----------------------------------------------------------------------------
    Debug("[comp/Tasks/SMS]: error sending message, error is '" . $IsMessage->error . "'");
    #-----------------------------------------------------------------------------
    return 3600;
}
#-------------------------------------------------------------------------------
$Event = Array(
    'UserID' => $ID,
    'Text' => SPrintF('Сообщение для (%s) через службу SMSC успешно отправлено', $Mobile)
);

$Event = Comp_Load('Events/EventInsert', $Event);
if (!$Event)
    return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------

?>
