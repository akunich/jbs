<?php
#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Task', 'Mobile', 'Message', 'ID');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
Debug(SPrintF('[comp/Tasks/SMS]: отправка SMS сообщения для (%u)', $Mobile));
#-------------------------------------------------------------------------------
$GLOBALS['TaskReturnInfo'] = $Mobile;
#-------------------------------------------------------------------------------
$Config = Config();

if (!Isset($Config['Notifies']['Methods']['SMS']['Provider'])) {
    return ERROR | @Trigger_Error(500);
}

$SMSProvider = $Config['Notifies']['Methods']['SMS']['Provider'];

Debug(SPrintF('[comp/Tasks/SMS]: провайдер (%s)', $SMSProvider));

if (Is_Error(System_Load(SPrintF('classes/%s.class.php', $SMSProvider))))
    return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Settings = $Config[$SMSProvider];
#-------------------------------------------------------------------------------
$Links = &Links();
#-------------------------------------------------------------------------------
$LinkID = Md5($SMSProvider);
#-------------------------------------------------------------------------------
if (!IsSet($Links[$LinkID])) {
    #-----------------------------------------------------------------------------
    $Links[$LinkID] = NULL;
    #-----------------------------------------------------------------------------
    $SMS = &$Links[$LinkID];
    #-----------------------------------------------------------------------------
    try {
        $SMS = $SMSProvider::get();
    }
    catch (Exception $e) {
        return ERROR | @Trigger_Error(500);
    }
}
#-------------------------------------------------------------------------------
$SMS = &$Links[$LinkID];
#-------------------------------------------------------------------------------
//$Message = Mb_Convert_Encoding($Message, $Settings['Charset']);
#-------------------------------------------------------------------------------
try {
    $IsMessage = $SMS->send($Mobile, $Message);
    if (Is_Error($IsMessage)) {
        throw new ErrorException("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
    }
}
catch (Exception $e) {
    #-----------------------------------------------------------------------------
    UnSet($Links[$LinkID]);
    #-----------------------------------------------------------------------------
    Debug("[comp/Tasks/SMS]: error sending message, error is '" . $e->getMessage() . "'");
    return new jException($e->getMessage());
    #-----------------------------------------------------------------------------
    return 3600;
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$Config['Notifies']['Methods']['SMS']['IsEvent'])
	return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Event = Array(
	'UserID'=> $ID,
	'Text'	=> SPrintF('Сообщение для (%s) через службу %s успешно отправлено', $Mobile, $SMSProvider)
);
#-------------------------------------------------------------------------------
$Event = Comp_Load('Events/EventInsert', $Event);
#-------------------------------------------------------------------------------
if (!$Event)
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------

?>
