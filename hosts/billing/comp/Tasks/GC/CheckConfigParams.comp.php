<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Params');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['GC']['CheckConfigParamsSettings'];
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$HostsIDs = Array_Reverse($GLOBALS['HOST_CONF']['HostsIDs']);
#-------------------------------------------------------------------------------
$ShareConfigsParams = Array();
#-------------------------------------------------------------------------------
foreach($HostsIDs as $HostsID){
	#-------------------------------------------------------------------------------
	if($HostsID != HOST_ID){
		#-------------------------------------------------------------------------------
		$HostConfig = System_XML('config/Config.xml',Array($HostsID));
		if(Is_Error($HostConfig)){
			#-------------------------------------------------------------------------------
			Debug(SPrintF('[comp/Tasks/GC/CheckConfigParams]: не удалось загрузить конфигурационный файл хоста %s',$HostsID));
			#-------------------------------------------------------------------------------
			continue;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		$Params = Array_ToLine($HostConfig);
		#-------------------------------------------------------------------------------
		foreach(Array_Keys($Params) as $Key)
			if(!In_Array($Key,$ShareConfigsParams))
				$ShareConfigsParams[] = $Key;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$PrivateConfig = System_XML('config/Config.xml',Array(HOST_ID));
if(Is_Error($PrivateConfig))
	return new gException('ERROR_TEMPLATE_LOAD','Ошибка загрузки шаблона');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// Строим шаблон для исключений - все методы уведомлений
$Array = Array();
#-------------------------------------------------------------------------------
foreach(Array_Keys($Config['Notifies']['Methods']) as $MethodID)
	$Array[] = $MethodID;
#-------------------------------------------------------------------------------
$Pattern = SPrintF('/[\w]\.Use(%s)$/',Implode('|',$Array));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Params = Array_ToLine($PrivateConfig);
#-------------------------------------------------------------------------------
foreach(Array_Keys($Params) as $Key){
	#-------------------------------------------------------------------------------
	if(!In_Array($Key,$ShareConfigsParams)){
		#-------------------------------------------------------------------------------
		// перебираем все методы уведомлений, проверяем исключения
		if(Preg_Match($Pattern,$Key))
			continue;
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[comp/Tasks/GC/CheckConfigParams]: в конфигурационном файле обнаружен не используемый параметр: %s',$Key));
		#-------------------------------------------------------------------------------
		if($Settings['IsEvent']){
			#-------------------------------------------------------------------------------
			$Event = Array('IsReaded'=>FALSE,'PriorityID'=>'System','Text'=>SPrintF('Обнаружен неиспользуемый параметр конфигурационного файла: %s, со значением (%s). Удалите его, или отключите задачу поиска неиспользуемых параметров. При удалении, будте аккуратны и внимательны, сохраняйте бэкап конфигурационного файла.',$Key,$Params[$Key]));
			$Event = Comp_Load('Events/EventInsert',$Event);
			if(!$Event)
				return ERROR | @Trigger_Error(500);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
