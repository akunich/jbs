<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Params');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Count = 0;
#-------------------------------------------------------------------------------
$Sessions = SPrintF('%s/sessions',$Tmp);
#-------------------------------------------------------------------------------
if(File_Exists($Sessions)){
	#-------------------------------------------------------------------------------
	$Files = IO_Scan($Sessions);
	if(Is_Error($Files))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	foreach($Files as $File){
		#-------------------------------------------------------------------------------
		$Path = SPrintF('%s/%s',$Sessions,$File);
		#-------------------------------------------------------------------------------
		if(Preg_Match('/^REMEBMER/',$File) && Time() - FileMTime($Path) < 24*3600*$Params['RememberTTL'])
			continue;
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		if(Time() - FileMTime($Path) > $Params['SessionTTL']){
			#-------------------------------------------------------------------------------
			if(UnLink($Path)){
				#-------------------------------------------------------------------------------
				$Count++;
				#-------------------------------------------------------------------------------
			}else{
				#-------------------------------------------------------------------------------
				return ERROR | @Trigger_Error(SPrintF('[comp/Tasks/Sessions]: не удалось удалить файл сессии (%s)',$Path));
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(SizeOF($Files) > 0){
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Tasks/GC/Sessions]: total %u sessions',SizeOF($Files)));
	#-------------------------------------------------------------------------------
	if($Count > 0)
		Debug(SPrintF('[comp/Tasks/GC/Sessions]: delete %u sessions ',$Count));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------

?>
