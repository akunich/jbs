<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Params');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Error(System_Load('libs/Upload.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
/*
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['GC']['CheckOrphanedFiles'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return TRUE;
#-------------------------------------------------------------------------------
if(Date('N') != $Settings['DayOfWeek'])
	return TRUE;
*/
#-------------------------------------------------------------------------------
// максимальный иденфтикатор из таблицы
$Max = DB_Select('Files',Array('MAX(`ID`) AS `ID`'),Array('UNIQ'));
if(Is_Error($Max))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// достаём все файлы из таблицы файлов
$Files = DB_Select('FilesOwners','*');
#-------------------------------------------------------------------------------
switch(ValueOf($Files)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	return TRUE;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$FilesExist = Array();
#-------------------------------------------------------------------------------
// перебираем файлы
foreach($Files as $File){
	#-------------------------------------------------------------------------------
/*	+ 50 секунд на 190k файлов
	// проверяем существование файла
	$Path = GetFilePath($File['ID']);
	#-------------------------------------------------------------------------------
	if(!File_Exists($Path['FilePath'])){
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[comp/www/CheckOrphanedFiles]: НЕ найден файл (%s)',$Path['FilePath']));
		#-------------------------------------------------------------------------------
		continue;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
*/
	// добавляем в массив идентифкатор файла
	$FilesExist[] = $File['ID'];
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Array = Array();
// перебираем идентфикаторы от максимального до нуля, проверяем их наличие в массиве
for($i = $Max['ID']; $i >= 1; $i--)
	$Array[] = $i;
#-------------------------------------------------------------------------------
// сортируем массивы
ASort($Array);
ASort($FilesExist);
#-------------------------------------------------------------------------------
// лишние 
$FilesOdd = Array_Diff($Array,$FilesExist);
#-------------------------------------------------------------------------------
if(SizeOf($FilesOdd) > 0){
	#-------------------------------------------------------------------------------
	foreach($FilesOdd as $FileOdd){
		//Debug(SPrintF('[comp/www/CheckOrphanedFiles]: дырка на файле (%s)',$FileOdd));
		// дырка в перечислении - файл удалён из таблицы. проверяем наличие файла на диске
		$Path = GetFilePath($FileOdd);
		#-------------------------------------------------------------------------------
		if(File_Exists($Path['FilePath'])){
			#-------------------------------------------------------------------------------
			Debug(SPrintF('[comp/www/CheckOrphanedFiles]: найден файл отсутствующий в таблице файлов (%s) ',$Path['FilePath']));
			#-------------------------------------------------------------------------------
			continue;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
