<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['BackUp'];
#-------------------------------------------------------------------------------
$ExecuteTime = Comp_Load('Formats/Task/ExecuteTime',Array('ExecutePeriod'=>$Settings['ExecutePeriod']));
if(Is_Error($ExecuteTime))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return 3600;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Result = DB_Query('SHOW TABLE STATUS');
if(Is_Error($Result))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Tables = MySQL::Result($Result);
if(Is_Error($Tables))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
foreach($Tables as $Table){
	#-----------------------------------------------------------------------------
	$TableID = $Table['Name'];
	#-----------------------------------------------------------------------------
	if(!$Table['Engine'])
		continue;
	#-----------------------------------------------------------------------------
	if($Table['Engine'] == 'MyISAM'){
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[comp/Tasks/BackUp]: Исправление ошибок в таблице (%s)',$TableID));
		#-------------------------------------------------------------------------------
		$Result = DB_Query(SPrintF('REPAIR TABLE `%s`',$TableID));
		if(Is_Error($Result))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Rows = MySQL::Result($Result);
		if(Is_Error($Rows))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		$Row = Current($Rows);
		#-----------------------------------------------------------------------------
		Debug(SPrintF('[comp/Tasks/BackUp]: Результат восстановления таблицы (%s) (%s)=[%s]',$TableID,$Row['Msg_type'],$Row['Msg_text']));
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Result = DB_Query(SPrintF('OPTIMIZE TABLE `%s`',$TableID));
	if(Is_Error($Result))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Rows = MySQL::Result($Result);
	if(Is_Error($Rows))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Row = Current($Rows);
	#-----------------------------------------------------------------------------
	Debug(SPrintF('[comp/Tasks/BackUp]: Результат оптимизации таблицы (%s) (%s)=[%s]',$TableID,$Row['Msg_type'],$Row['Msg_text']));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DBConnection = $Config['DBConnection'];
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Folder = SPrintF('%s/db',$Tmp);
#-------------------------------------------------------------------------------
if(!File_Exists($Folder)){
	#-------------------------------------------------------------------------------
	if(!@MkDir($Folder,0777,TRUE))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
$File = SPrintF('%s/%s.sql',$Folder,Date('D'));
#-------------------------------------------------------------------------------
$Command = 'mysqldump --host=%s --port=%u --user=%s --password=%s --quote-names -r %s %s 2>&1';
#-------------------------------------------------------------------------------
$Command = SPrintF($Command,$DBConnection['Server'],$DBConnection['Port'],$DBConnection['User'],$DBConnection['Password'],$File,$DBConnection['DbName']);
#-------------------------------------------------------------------------------
Debug(SPrintF('[comp/Tasks/BackUp]: команда консоли (%s)',$Command));
#-------------------------------------------------------------------------------
$Log = Array();
#-------------------------------------------------------------------------------
if(Exec($Command,$Log))
	return ERROR | @Trigger_Error(SPrintF("[comp/Tasks/BackUp]: ошибка выполнения команды:\n%s",Implode("\n",$Log)));
#-------------------------------------------------------------------------------
if(!File_Exists($File))
	return ERROR | @Trigger_Error('[comp/Tasks/BackUp]: файл резервной копии не был создан');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $ExecuteTime;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
