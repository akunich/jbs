<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$NumTotal = 0;
$NumDeleted = 0;
#-------------------------------------------------------------------------------
$Sessions = SPrintF('%s/sessions',$Tmp);
#-------------------------------------------------------------------------------
if(File_Exists($Sessions)){
  #-----------------------------------------------------------------------------
  $Files = IO_Scan($Sessions);
  if(Is_Error($Files))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  foreach($Files as $File){
    #---------------------------------------------------------------------------
    $NumTotal++;
    #---------------------------------------------------------------------------
    $Path = SPrintF('%s/%s',$Sessions,$File);
    #---------------------------------------------------------------------------
    if(Preg_Match('/^REMEBMER/',$File) && Time() - FileMTime($Path) < 2678400)
      continue;
    #---------------------------------------------------------------------------
    #---------------------------------------------------------------------------
    if(Time() - FileMTime($Path) > 3600){
      #-------------------------------------------------------------------------
      if(UnLink($Path)){
        $NumDeleted++;
      }else{
        return ERROR | @Trigger_Error(SPrintF('[comp/Tasks/Sessions]: не удалось удалить файл сессии (%s)',$Path));
      }
    }
  }
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($NumTotal > 0){
	$GLOBALS['TaskReturnInfo'] = Array(SPrintF('Total: %u',$NumTotal));
	if($NumDeleted > 0){
		$GLOBALS['TaskReturnInfo'][] = SPrintF('Delete: %u sessions',$NumDeleted);
	}
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return 180;
#-------------------------------------------------------------------------------

?>
