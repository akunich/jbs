<?php

#-------------------------------------------------------------------------------
/** @author Кунич А.С. */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('SystemID','InvoiceID','Summ');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Invoices']['PaymentSystems']['OnPay'];
#-------------------------------------------------------------------------------
$Send = $Settings['Send'];
#-------------------------------------------------------------------------------
$Send['pay_for'] = $InvoiceID;
#-------------------------------------------------------------------------------
$Send['f'] = 11;
#-------------------------------------------------------------------------------
$PriceFinal = true;
#-------------------------------------------------------------------------------
if($PriceFinal)
	$Send['PriceFinal'] = 'true';
#-------------------------------------------------------------------------------
$Protocol = (@$_SERVER['SERVER_PORT'] != 80?'https':'http');
#-------------------------------------------------------------------------------
$Send['url_success']  = SPrintF('%s://%s/Invoices',$Protocol,HOST_ID);
#-------------------------------------------------------------------------------
$Send['url_fail']  = SPrintF('%s://%s/Invoices?Error=yes',$Protocol,HOST_ID);
#-------------------------------------------------------------------------------
$Send['price'] = Round($Summ/$Settings['Course'],2);
#-------------------------------------------------------------------------------
$Send['price_md5'] = Number_Format($Send['price'], 2, '.', '');
#-------------------------------------------------------------------------------
if(SubStr($Send['price_md5'], -1) == "0")
	$Send['price_md5'] = Number_Format($Send['price'], 1, '.', ''); 
#-------------------------------------------------------------------------------
$Send['ticker'] = 'RUR';
#-------------------------------------------------------------------------------
$Send['convert'] = 'yes';
#-------------------------------------------------------------------------------
$Hash = Array(
	$Send['pay_mode'],
	$Send['price_md5'],
	$Send['ticker'],
	$Send['pay_for'],
	$Send['convert'],
	$Settings['MerchantPass']
);
#-------------------------------------------------------------------------------
$Send['md5'] = Md5(Implode(';',$Hash));
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Formats/Invoice/Number',$InvoiceID);
if(Is_Error($Comp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
if($__USER['Params']['NotificationMethods']['SMS']['Address'] && $__USER['Params']['NotificationMethods']['SMS']['Confirmed'])
	$Send['user_phone'] = $__USER['Params']['NotificationMethods']['SMS']['Address'];
#-------------------------------------------------------------------------------
$Send['user_email'] = $__USER['Email'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Send;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
