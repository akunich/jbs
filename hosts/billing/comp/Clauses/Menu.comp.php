<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Pattern');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Where = SPrintF("`Partition` LIKE '%s' AND `IsPublish` = 'yes'",DB_Escape($Pattern));
#-------------------------------------------------------------------------------
$Clauses = DB_Select('Clauses',Array('ID','PublicDate','ChangedDate','EditorID','Partition','Title','Text'),Array('Where'=>$Where,'SortOn'=>'PublicDate'));
#-------------------------------------------------------------------------------
switch(ValueOf($Clauses)){
  case 'error':
    return ERROR | @Trigger_Error(500);
  case 'exception':
    #---------------------------------------------------------------------------
    $Comp = Comp_Load('Information','Статьи не найдены.','Notice');
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    return $Comp;
  case 'array':
    #---------------------------------------------------------------------------
    $Ul = new Tag('UL',Array('class'=>'Standard'));
    #---------------------------------------------------------------------------
    foreach($Clauses as $Clause){
      #-------------------------------------------------------------------------
      $Li = new Tag('LI',Array('style'=>'border-bottom:1px dashed #DCDCDC;'),new Tag('A',Array('href'=>SPrintF('/Clause?ClauseID=%s',$Clause['Partition'])),$Clause['Title']));
      #-------------------------------------------------------------------------
      $Text = '';
      #-------------------------------------------------------------------------
      if(Preg_Match_All('/<\s*[P|TD|DIV].*>(.+)<\s*\/[P|TD|DIV].*>/siU',$Clause['Text'],$Matches)){
        #-----------------------------------------------------------------------
        $Matches = Next($Matches);
        #-----------------------------------------------------------------------
        for($i=0;$i<Count($Matches);$i++)
          $Text .= SPrintF('%s ',$Matches[$i]);
      }
      #-------------------------------------------------------------------------
      $Text = Mb_SubStr(Html_Entity_Decode(Strip_Tags(Trim($Text))),0,200);
      #-------------------------------------------------------------------------
      if($Text){
        #-----------------------------------------------------------------------
        $Div = new Tag('DIV',Array('style'=>'color:#848484;'),SPrintF('%s...',$Text));
        #-----------------------------------------------------------------------
        $Li->AddChild($Div);
      }
      #-------------------------------------------------------------------------
      $EditorID = $Clause['EditorID'];
      #-------------------------------------------------------------------------
      if($EditorID > 1){
        #-----------------------------------------------------------------------
        $Editor = DB_Select('Users','Name',Array('UNIQ','ID'=>$EditorID));
        #-----------------------------------------------------------------------
        switch(ValueOf($Editor)){
          case 'error':
            return ERROR | @Trigger_Error(500);
          case 'exception':
            return ERROR | @Trigger_Error(400);
          case 'array':
            # No more...
          break;
          default:
            return ERROR | @Trigger_Error(101);
        }
        #-----------------------------------------------------------------------
        $Comp = Comp_Load('Formats/Date/Extended',$Clause['ChangedDate']?$Clause['ChangedDate']:$Clause['PublicDate']);
        if(Is_Error($Comp))
          return ERROR | @Trigger_Error(500);
        #-----------------------------------------------------------------------
        $Li->AddChild(new Tag('DIV',Array('style'=>'font-size:11px;color:#969696;'),SPrintF('%s | %s',$Editor['Name'],$Comp)));
      }
      #-------------------------------------------------------------------------
      $Ul->AddChild($Li);
    }
    #---------------------------------------------------------------------------
    return $Ul;
  default:
    return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------

?>
