<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/

class Viber
{
	#-------------------------------------------------------------------------------
	// параметры
	public $Address	= 'https://chatapi.viber.com/pa/';
	public $Host	= 'chatapi.viber.com';
	public $Token	= '00-000-00';
	#-------------------------------------------------------------------------------
	public function __construct($Token) {
		$this->Token = $Token;
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------

	// послать юзеру
	public function MessageSend
	(
		$RecipientID,		// получатель
		$Text			// Текст.
	)
	{
		#-------------------------------------------------------------------------------
		$Data['receiver']	= $RecipientID;
		$Data['text']		= $Text;
		$Data['type']		= 'text';
		#-------------------------------------------------------------------------------
		return $this->API('send_message', $Data);
		#-------------------------------------------------------------------------------
	}

	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// вебхук
	public function SetWebHook()
	{
		#-------------------------------------------------------------------------------
		$Data['url']   = $this->WebHook;
		#-------------------------------------------------------------------------------
		return $this->API('set_webhook', $Data);
		#-------------------------------------------------------------------------------
	}

	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// инфа
	public function get_account_info()
	{
		return $this->API('get_account_info'/*, $Data*/);
	}

	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// АПИ
	private function API($Method, $Data = Array()){
		#-------------------------------------------------------------------------------
		$HTTP = Array(
				'Address'	=> $this->Host,
				'Port'		=> 443,
				'Host'		=> $this->Host,
				'Protocol'	=> 'ssl',
				);
		#-------------------------------------------------------------------------------
		$Data['auth_token']	= $this->Token;
		#-------------------------------------------------------------------------------
		$Url = SPrintF('/pa/%s',$Method);
		#-------------------------------------------------------------------------------
		$Result = HTTP_Send($Url,$HTTP,Array(),Json_Encode($Data));
		if(Is_Error($Result))
			return ERROR | @Trigger_Error('[API]: не удалось выполнить запрос к серверу');
		#-------------------------------------------------------------------------------
		$Result = Trim($Result['Body']);
		#-------------------------------------------------------------------------------
		$Result = Json_Decode($Result,TRUE);
		#-------------------------------------------------------------------------------
		return $Result;
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
	}

	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// проверяем подпись
	public function CheckSign($Body,$Sign){
		#-------------------------------------------------------------------------------
		$Hash = Hash_Hmac('sha256',$Body,$this->Token);
		#-------------------------------------------------------------------------------
		return Hash_Equals($Sign,$Hash);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}

?>
