#-------------------------------------------------------------------------------
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
#if($_SERVER['REMOTE_ADDR'] != "188.120.241.143" || $_SERVER['REMOTE_ADDR'] != "77.73.25.114")
#  return new gException('UPDATES_LOCKED','Нет обновлений');
#-------------------------------------------------------------------------------
$HostsIDs = (string) @$Args['HostsIDs'];
$Snapshot = (string) @$Args['Snapshot'];
#-------------------------------------------------------------------------------
#TODO: delete this
if(!$HostsIDs)
  $HostsIDs = 'hosting,billing,root';
#-------------------------------------------------------------------------------
if(!$Snapshot)
  return Array('Status'=>'Ok','HostsIDs'=>$HostsIDs);
#TODO: delete this
#-------------------------------------------------------------------------------
$HostsIDs = Explode(',',$HostsIDs);
if(!Count($HostsIDs))
  return new gException('WRONG_SNAPSHOT','Список хостов не был передан');
#-------------------------------------------------------------------------------
$Client = @JSON_Decode($Snapshot,TRUE);
if(!Is_Array($Client))
  return new gException('WRONG_SNAPSHOT','Неверный снимок файлов');
#-------------------------------------------------------------------------------
if(!Define('UPDATE_PATH',File_Exists('/work/releases/jbs')?'/work/releases/jbs':'/work/www/jbs/trunk'))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(File_Exists(SPrintF('%s/.lock',UPDATE_PATH)))
  return new gException('UPDATES_LOCKED','Нет обновлений.');
#-------------------------------------------------------------------------------
$Server = Array();
#-------------------------------------------------------------------------------
$Folders = Array('hosts','styles','db','scripts','others','patches');
#-------------------------------------------------------------------------------
foreach($Folders as $Folder){
  #-----------------------------------------------------------------------------
  foreach($HostsIDs as $HostID){
    #---------------------------------------------------------------------------
    $Path = SPrintF('%s/%s/%s',UPDATE_PATH,$Folder,$HostID);
    #---------------------------------------------------------------------------
    if(!File_Exists($Path))
      continue;
    #---------------------------------------------------------------------------
    $Files = IO_Files($Path);
    if(Is_Error($Files))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    foreach($Files as $File){
      #-------------------------------------------------------------------------
      if(Preg_Match('/LastPatchFiles/',$File))
        continue;
      #-------------------------------------------------------------------------
      $MD5 = MD5_File($File);
      if(!$MD5)
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
      $File = SubStr($File,StrLen(UPDATE_PATH)+1);
      #-------------------------------------------------------------------------
      $Server[SPrintF('MD5%s',MD5(SPrintF('%s-%s',$MD5,MD5($File))))] = $File;
    }
  }
}
#-------------------------------------------------------------------------------
$Files = IO_Files(SPrintF('%s/core',UPDATE_PATH));
if(Is_Error($Files))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
foreach($Files as $File){
  #-----------------------------------------------------------------------------
  $MD5 = MD5_File($File);
  if(!$MD5)
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  $File = SubStr($File,StrLen(UPDATE_PATH)+1);
  #-----------------------------------------------------------------------------
  $Server[SPrintF('MD5%s',MD5(SPrintF('%s-%s',$MD5,MD5($File))))] = $File;
}
#-------------------------------------------------------------------------------
$Answer = $Added = Array();
#-------------------------------------------------------------------------------
foreach(Array_Keys($Server) as $MD5){
  #-----------------------------------------------------------------------------
  if(!IsSet($Client[$MD5])){
    #---------------------------------------------------------------------------
    $File = $Server[$MD5];
    #---------------------------------------------------------------------------
    $Source = IO_Read(SPrintF('%s/%s',UPDATE_PATH,$File),FALSE);
    if(Is_Error($Source))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Added[SPrintF('MD5%s',MD5($File))] = Array('File'=>$File,'Source'=>Base64_Encode($Source));
  }
}
#-------------------------------------------------------------------------------
if(Count($Added))
  $Answer['Added'] = $Added;
#-------------------------------------------------------------------------------
$Deleted = Array();
#-------------------------------------------------------------------------------
foreach(Array_Keys($Client) as $MD5){
  #-----------------------------------------------------------------------------
  if(!IsSet($Server[$MD5]))
    $Deleted[SPrintF('MD5%s',MD5($File = $Client[$MD5]))] = $File;
}
#-------------------------------------------------------------------------------
foreach(Array_Keys($Added) as $MD5)
  UnSet($Deleted[$MD5]);
#-------------------------------------------------------------------------------
if(Count($Deleted))
  $Answer['Deleted'] = $Deleted;
#-------------------------------------------------------------------------------
if(!Count($Answer))
  return new gException('NO_CHANGES','Нет изменений');
#-------------------------------------------------------------------------------
$Answer['Status'] = 'Ok';
#-------------------------------------------------------------------------------
return $Answer;
#-------------------------------------------------------------------------------
