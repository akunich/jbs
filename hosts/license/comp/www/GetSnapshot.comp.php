
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
Header('Content-type: text/plain; charset=utf-8');
#-------------------------------------------------------------------------------
if(!Define('UPDATE_PATH',File_Exists('/work/releases/jbs')?'/work/releases/jbs':'/work/www/jbs/trunk'))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(File_Exists(SPrintF('%s/.lock',UPDATE_PATH)))
  return new gException('JBS_SERVER_LOCKED','Сервер обновлений временно заблокирован');
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$HostsIDs = Array('hosting','billing','root');
#-------------------------------------------------------------------------------
$Gzip = SPrintF('%s/public/JBs.tar.gz',$Tmp);
#-------------------------------------------------------------------------------
if(File_Exists($Gzip))
  UnLink($Gzip);
#-------------------------------------------------------------------------------
$Tar = SPrintF('%s/public/JBs.tar',$Tmp);
#-------------------------------------------------------------------------------
$IsWrite = IO_Write($File = SPrintF('%s/HostsIDs.txt',$Tmp),Implode(',',$HostsIDs));
if(Is_Error($IsWrite))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
echo "HostsIDs.txt\n";
#-------------------------------------------------------------------------------
$Command = SPrintF('cd %s;tar --create --file=%s HostsIDs.txt',$Tmp,$Tar);
#-------------------------------------------------------------------------------
$Log = Array();
#-------------------------------------------------------------------------------
if(Exec($Command,$Log))
  return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
#-------------------------------------------------------------------------------
UnLink($File);
#-------------------------------------------------------------------------------
$Snapshot = Array();
#-------------------------------------------------------------------------------
$Folders = Array('hosts','styles','db','scripts','others','patches');
#-------------------------------------------------------------------------------
foreach($Folders as $Folder){
  #-----------------------------------------------------------------------------
  foreach($HostsIDs as $HostID){
    #---------------------------------------------------------------------------
    $Path = SPrintF('%s/%s/%s',UPDATE_PATH,$Folder,$HostID);
    #---------------------------------------------------------------------------
    if(!File_Exists($Path))
      continue;
    #---------------------------------------------------------------------------
    $Files = IO_Files($Path);
    if(Is_Error($Files))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    foreach($Files as $File){
      #-------------------------------------------------------------------------
      $File = SubStr($File,StrLen(UPDATE_PATH)+1);
      #-------------------------------------------------------------------------
      echo SPrintF("%s\n",$File);
      #-------------------------------------------------------------------------
      $Command = SPrintF('cd %s;tar --append --file=%s %s',UPDATE_PATH,$Tar,$File);
      #-------------------------------------------------------------------------
      $Log = Array();
      #-------------------------------------------------------------------------
      if(Exec($Command,$Log))
        return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
    }
  }
}
#-------------------------------------------------------------------------------
$Files = IO_Files(SPrintF('%s/core',UPDATE_PATH));
if(Is_Error($Files))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
foreach($Files as $File){
  #-----------------------------------------------------------------------------
  $File = SubStr($File,StrLen(UPDATE_PATH)+1);
  #-----------------------------------------------------------------------------
  echo SPrintF("%s\n",$File);
  #-----------------------------------------------------------------------------
  $Command = SPrintF('cd %s;tar --append --file=%s %s',UPDATE_PATH,$Tar,$File);
  #-----------------------------------------------------------------------------
  $Log = Array();
  #-----------------------------------------------------------------------------
  if(Exec($Command,$Log))
    return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
}
#-------------------------------------------------------------------------------
echo "index.php\n";
#-------------------------------------------------------------------------------
$Command = SPrintF('cd %s;tar --append --file=%s %s',UPDATE_PATH,$Tar,'index.php');
#-------------------------------------------------------------------------------
$Log = Array();
#-------------------------------------------------------------------------------
if(Exec($Command,$Log))
  return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
#-------------------------------------------------------------------------------
echo ".htaccess\n";
#-------------------------------------------------------------------------------
$Command = SPrintF('cd %s;tar --append --file=%s %s',UPDATE_PATH,$Tar,'.htaccess');
#-------------------------------------------------------------------------------
$Log = Array();
#-------------------------------------------------------------------------------
if(Exec($Command,$Log))
  return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
#-------------------------------------------------------------------------------
echo "INSTALL\n";
#-------------------------------------------------------------------------------
$Command = SPrintF('cd %s;tar --append --file=%s %s',UPDATE_PATH,$Tar,'INSTALL');
#-------------------------------------------------------------------------------
$Log = Array();
#-------------------------------------------------------------------------------
if(Exec($Command,$Log))
  return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
#-------------------------------------------------------------------------------
echo "Сжатие архива\n";
#-------------------------------------------------------------------------------
$Command = SPrintF('cd %s;gzip %s',UPDATE_PATH,$Tar);
#-------------------------------------------------------------------------------
$Log = Array();
#-------------------------------------------------------------------------------
if(Exec($Command,$Log))
  return ERROR | @Trigger_Error(SPrintF("Ошибка выполнения команды:\n%s",Implode("\n",$Log)));
#-------------------------------------------------------------------------------
return 'OK';
#-------------------------------------------------------------------------------
