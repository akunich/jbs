<?php
#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
#-------------------------------------------------------------------------------
if(!Function_Exists('MemCache_Connect'))
  $GLOBALS['__MESSAGES'][] = 'Модуль memcache не установлен. Функции кеширования не доступны.';
#-------------------------------------------------------------------------------
function MemoryCache_Add($Key,$Value,$Time = 0){
  /****************************************************************************/
  $__args_types = Array('string','boolean,integer,string,array,object','integer');
  #-----------------------------------------------------------------------------
  $__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
  /****************************************************************************/
  $Link = &Link_Get('MemoryCache');
  #-----------------------------------------------------------------------------
  if($Link === FALSE)
    return ERROR;
  #-----------------------------------------------------------------------------
  if(!Function_Exists('MemCache_Connect')){
    #---------------------------------------------------------------------------
    $Link = FALSE;
    #---------------------------------------------------------------------------
    return ERROR | @Trigger_Error('[MemoryCache_Add]: модуль кеширования не установлен');
  }
  #-----------------------------------------------------------------------------
  if(!Is_Object($Link)){
    #---------------------------------------------------------------------------
    $Port = (IsSet($GLOBALS['HOST_CONF']['memcached.port'])?$GLOBALS['HOST_CONF']['memcached.port']:11211);
    #---------------------------------------------------------------------------
    $Link = @MemCache_Connect('localhost',$Port,0x1);
    #---------------------------------------------------------------------------
    if(!$Link){
      #-------------------------------------------------------------------------
      $Link = FALSE;
      #-------------------------------------------------------------------------
      return ERROR | @Trigger_Error('[MemoryCache_Add]: не удалось подключиться к серверу кеширования');
    }
    #---------------------------------------------------------------------------
    $Version = @MemCache_Get_Version($Link);
    #---------------------------------------------------------------------------
    Debug(SPrintF('[MemoryCache_Add]: соединение с сервером кеширования установлено версия (%s)',$Version));
  }
  #-----------------------------------------------------------------------------
  $Key = SPrintF('[%s]-%s',HOST_ID,$Key);
  #-----------------------------------------------------------------------------
  $Result = @MemCache_Add($Link,$Key,$Value,NULL,$Time);
  if(!$Result)
    return ERROR | @Trigger_Error('[MemoryCache_Add]: не удалось закешировать объект');
  #-----------------------------------------------------------------------------
  return TRUE;
}
#-------------------------------------------------------------------------------
function MemoryCache_Get($Key){
  /****************************************************************************/
  $__args_types = Array('string');
  #-----------------------------------------------------------------------------
  $__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
  /****************************************************************************/
  $Link = &Link_Get('MemoryCache');
  #-----------------------------------------------------------------------------
  if($Link === FALSE)
    return ERROR;
  #-----------------------------------------------------------------------------
  if(!Function_Exists('MemCache_Connect')){
    #---------------------------------------------------------------------------
    $Link = FALSE;
    #---------------------------------------------------------------------------
    return ERROR | @Trigger_Error('[MemoryCache_Get]: модуль кеширования не установлен');
  }
  #-----------------------------------------------------------------------------
  if(!Is_Object($Link)){
    #---------------------------------------------------------------------------
    $Port = (IsSet($GLOBALS['HOST_CONF']['memcached.port'])?$GLOBALS['HOST_CONF']['memcached.port']:11211);
    #---------------------------------------------------------------------------
    $Link = @MemCache_Connect('localhost',$Port,0x1);
    #---------------------------------------------------------------------------
    if(!$Link){
      #-------------------------------------------------------------------------
      $Link = NULL;
      #-------------------------------------------------------------------------
      return ERROR | @Trigger_Error('[MemoryCache_Get]: не удалось подключиться к серверу кеширования');
    }
    #---------------------------------------------------------------------------
    $Version = @MemCache_Get_Version($Link);
    #---------------------------------------------------------------------------
    Debug(SPrintF('[MemoryCache_Get]: соединение с сервером кеширования установлено версия (%s)',$Version));
  }
  #-----------------------------------------------------------------------------
  $Key = SPrintF('[%s]-%s',HOST_ID,$Key);
  #-----------------------------------------------------------------------------
  $Result = @MemCache_Get($Link,$Key);
  if($Result === FALSE)
    return ERROR | @Trigger_Error('[MemoryCache_Get]: не удалось извлечь объект');
  #-----------------------------------------------------------------------------
  return $Result;
}
#-------------------------------------------------------------------------------
function MemoryCache_Flush(){
  #-----------------------------------------------------------------------------
  $Link = &Link_Get('MemoryCache');
  #-----------------------------------------------------------------------------
  if($Link === FALSE)
    return ERROR;
  #-----------------------------------------------------------------------------
  if(!Function_Exists('MemCache_Connect')){
    #---------------------------------------------------------------------------
    $Link = FALSE;
    #---------------------------------------------------------------------------
    return ERROR | @Trigger_Error('[MemoryCache_Flush]: модуль кеширования не установлен');
  }
  #-----------------------------------------------------------------------------
  if(!Is_Object($Link)){
    #---------------------------------------------------------------------------
    $Port = (IsSet($GLOBALS['HOST_CONF']['memcached.port'])?$GLOBALS['HOST_CONF']['memcached.port']:11211);
    #---------------------------------------------------------------------------
    $Link = @MemCache_Connect('localhost',$Port,0x1);
    #---------------------------------------------------------------------------
    if(!$Link){
      #-------------------------------------------------------------------------
      $Link = NULL;
      #-------------------------------------------------------------------------
      return ERROR | @Trigger_Error('[MemoryCache_Flush]: не удалось подключиться к серверу кеширования');
    }
    #---------------------------------------------------------------------------
    $Version = @MemCache_Get_Version($Link);
    #---------------------------------------------------------------------------
    SPrintF('[MemoryCache_Flush]: соединение с сервером кеширования установлено версия (%s)',$Version);
  }
  #-----------------------------------------------------------------------------
  $Result = @MemCache_Flush($Link);
  if($Result === FALSE)
    return ERROR | @Trigger_Error('[MemoryCache_Flush]: не удалось очистить память');
  #-----------------------------------------------------------------------------
  return TRUE;
}
#-------------------------------------------------------------------------------
function MemoryCache_Get_Stats(){
  #-----------------------------------------------------------------------------
  $Link = &Link_Get('MemoryCache');
  #-----------------------------------------------------------------------------
  if($Link === FALSE)
    return ERROR;
  #-----------------------------------------------------------------------------
  if(!Function_Exists('MemCache_Connect')){
    #---------------------------------------------------------------------------
    $Link = FALSE;
    #---------------------------------------------------------------------------
    return ERROR | @Trigger_Error('[MemoryCache_Get_Stats]: модуль кеширования не установлен');
  }
  #-----------------------------------------------------------------------------
  if(!Is_Object($Link)){
    #---------------------------------------------------------------------------
    $Port = (IsSet($GLOBALS['HOST_CONF']['memcached.port'])?$GLOBALS['HOST_CONF']['memcached.port']:11211);
    #---------------------------------------------------------------------------
    $Link = @MemCache_Connect('localhost',$Port,0x1);
    #---------------------------------------------------------------------------
    if(!$Link){
      #-------------------------------------------------------------------------
      $Link = NULL;
      #-------------------------------------------------------------------------
      return ERROR | @Trigger_Error('[MemoryCache_Get_Stats]: не удалось подключиться к серверу кеширования');
    }
    #---------------------------------------------------------------------------
    $Version = @MemCache_Get_Version($Link);
    #---------------------------------------------------------------------------
    SPrintF('[MemoryCache_Get_Stats]: соединение с сервером кеширования установлено версия (%s)',$Version);
  }
  #-----------------------------------------------------------------------------
  $Result = @Memcache_Get_Stats($Link);
  if($Result === FALSE)
    return ERROR | @Trigger_Error('[MemoryCache_Get_Stats]: не удалось получить статистику кэшированной памяти');
  #-----------------------------------------------------------------------------
  return $Result;
}

#-------------------------------------------------------------------------------
function MemoryCache_IsOnLine(){
  #-----------------------------------------------------------------------------
  $Link = &Link_Get('MemoryCache');
  #-----------------------------------------------------------------------------
  if($Link === FALSE)
    return FALSE;
  #-----------------------------------------------------------------------------
  if(!Function_Exists('MemCache_Connect')){
    #---------------------------------------------------------------------------
    $Link = FALSE;
    #---------------------------------------------------------------------------
    return ERROR | @Trigger_Error('[MemoryCache_IsOnLine]: модуль кеширования не установлен');
  }
  #-----------------------------------------------------------------------------
  if(!Is_Object($Link)){
    #---------------------------------------------------------------------------
    $Port = (IsSet($GLOBALS['HOST_CONF']['memcached.port'])?$GLOBALS['HOST_CONF']['memcached.port']:11211);
    #---------------------------------------------------------------------------
    $Link = @MemCache_Connect('localhost',$Port,0x1);
    #---------------------------------------------------------------------------
    if(!$Link){
      #-------------------------------------------------------------------------
      $Link = NULL;
      #-------------------------------------------------------------------------
      return FALSE;
    }
  }
  #-----------------------------------------------------------------------------
  return TRUE;
}
#-------------------------------------------------------------------------------
?>
