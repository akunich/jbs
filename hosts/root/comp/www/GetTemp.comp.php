<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$File = (string) @$Args['File'];
$Name = (string) @$Args['Name'];
$Mime = (string) @$Args['Mime'];
#-------------------------------------------------------------------------------
if(!Preg_Match('/^[a-zA-Z0-9\_\.\]\[]+$/',$File))
	return 'Не верно указано имя файла';
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Path = SPrintF('%s/files/%s',$Tmp,$File);
#-------------------------------------------------------------------------------
if(!File_Exists($Path))
	return 'Файл не существует';
#-------------------------------------------------------------------------------
$Source = IO_Read($Path);
if(Is_Error($Source))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Length = MB_StrLen($Source,'ASCII');
#-------------------------------------------------------------------------------
Header(SPrintF('Content-Type: %s; charset=utf-8',$Mime?$Mime:'application'));
Header(SPrintF('Content-Length: %u',$Length));
Header(SPrintF('Content-Disposition: attachment; filename="%s";',$Name?AddSlashes($Name):$File));
Header('Pragma: nocache');
#-------------------------------------------------------------------------------
echo $Source;
#-------------------------------------------------------------------------------


?>
