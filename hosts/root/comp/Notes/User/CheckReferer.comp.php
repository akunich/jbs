<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru  **/
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Result = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Interface']['User']['Notes']['CheckReferer'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$Settings['ShowCheckReferer'])
	return $Result;
#-------------------------------------------------------------------------------
# также, проверяем используется ли проверка отсутствия реферера.
# если нет - нет смысла чё-то выводить юзеру
if($Config['Other']['Modules']['Security']['IsNoReferer'])
	return $Result;
#-------------------------------------------------------------------------------
$CacheID = Md5(SPrintF('no-referer-%s-%s',$GLOBALS['__USER']['ID'],$_SERVER['REMOTE_ADDR']));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!IsSet($_SERVER["HTTP_REFERER"])){
	#-------------------------------------------------------------------------------
	$Count = IntVal(CacheManager::get($CacheID));
	#-------------------------------------------------------------------------------
	if($Count > 2){
		#-------------------------------------------------------------------------------
		$NoBody = new Tag('NOBODY');
		#-------------------------------------------------------------------------------
		$NoBody->AddHTML(TemplateReplace('Notes.User.CheckReferer'));
		#-------------------------------------------------------------------------------
		$Result[] = $NoBody;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Count++;
	#-------------------------------------------------------------------------------
	CacheManager::add($CacheID,$Count,600);
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Notes/User/CheckReferer]: HTTP_REFERER is not set for IP = %s, Count = %u',$_SERVER['REMOTE_ADDR'],$Count));
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	CacheManager::add($CacheID,0,600);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Result;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
