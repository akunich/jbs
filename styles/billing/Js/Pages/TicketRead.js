//------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
function TicketAddMessage(){
	//------------------------------------------------------------------------------
	var $Form = document.forms['TicketReadForm'];
	//------------------------------------------------------------------------------
	$HTTP = new HTTP();
	//------------------------------------------------------------------------------
	if(!$HTTP.Resource){
		//------------------------------------------------------------------------------
		alert('Не удалось создать HTTP соединение');
		//------------------------------------------------------------------------------
		return false;
		//------------------------------------------------------------------------------
	}
	//------------------------------------------------------------------------------
	//------------------------------------------------------------------------------
	$HTTP.onLoaded = function(){
		HideProgress();
	}
	//------------------------------------------------------------------------------
	//------------------------------------------------------------------------------
	$HTTP.onAnswer = function($Answer){
		//------------------------------------------------------------------------------
		switch($Answer.Status){
		case 'Error':
			//------------------------------------------------------------------------------
			ShowAlert($Answer.Error.String,'Warning');
			//------------------------------------------------------------------------------
			break;
			//------------------------------------------------------------------------------
		case 'Exception':
			//------------------------------------------------------------------------------
			ShowAlert(ExceptionsStack($Answer.Exception),'Warning');
			//------------------------------------------------------------------------------
			break;
			//------------------------------------------------------------------------------
		case 'Ok':
			//------------------------------------------------------------------------------
			var $Form = document.forms['TicketReadForm'];
			//------------------------------------------------------------------------------
			if($Form.IsNext){
				//------------------------------------------------------------------------------
				if($Form.IsNext.checked){
					//------------------------------------------------------------------------------
					ShowWindow('/TicketRead',{TicketID:$Form.IsNext.value});
					//------------------------------------------------------------------------------
					break;
					//------------------------------------------------------------------------------
				}
				//------------------------------------------------------------------------------
			}
			//------------------------------------------------------------------------------
			//------------------------------------------------------------------------------
			if($Form.Flags.selectedIndex){
				//------------------------------------------------------------------------------
				var Selected = $Form.Flags.selectedIndex;
				//------------------------------------------------------------------------------
				var SelectedOption = $Form.Flags.options[Selected].value;
				//------------------------------------------------------------------------------
				if(SelectedOption != "No"){
					//------------------------------------------------------------------------------
					var Close = "yes";
					//------------------------------------------------------------------------------
				}else{
					//------------------------------------------------------------------------------
					var Close = "no";
					//------------------------------------------------------------------------------
				}
				//------------------------------------------------------------------------------
			}else{
				//------------------------------------------------------------------------------
				if($Form.Flags.checked){
					//------------------------------------------------------------------------------
					var Close = "yes";
					//------------------------------------------------------------------------------
				}else{
					//------------------------------------------------------------------------------
					var Close = "no";
					//------------------------------------------------------------------------------
				}
				//------------------------------------------------------------------------------
			}
			//------------------------------------------------------------------------------
			// если тикет закрывают - то закрываем окно, если нет - перезагружаем страницу
			if(Close == "yes"){
				//------------------------------------------------------------------------------
				//GetURL(document.location);
				// юзер или админ - разный УРЛ
				if($Form.IsAdmin.value == 1){
					//------------------------------------------------------------------------------
					GetURL('/Administrator/Tickets');
					//------------------------------------------------------------------------------
				}else{
					//------------------------------------------------------------------------------
					GetURL('/Tickets');
					//------------------------------------------------------------------------------
				}
				//------------------------------------------------------------------------------
			}else{
				//------------------------------------------------------------------------------
				// на внутреннем запросе перезагружаем всю страницу, иначе - только фрейм
				if($Form.IsInternal.value == 1){
					//------------------------------------------------------------------------------
					GetURL(document.location);
					//------------------------------------------------------------------------------
				}else{
					document.forms['TicketReadForm'].Message.value = '';
					//------------------------------------------------------------------------------
					UploadDelete();
					//------------------------------------------------------------------------------
					document.getElementById('TicketReadMessages').contentWindow.document.location.reload();
					//------------------------------------------------------------------------------
				}
			}
			//------------------------------------------------------------------------------
			break;
			//------------------------------------------------------------------------------
		default:
			alert('Не известный ответ');
		}
		//------------------------------------------------------------------------------
	}
	//------------------------------------------------------------------------------
	//------------------------------------------------------------------------------
	var $Args = FormGet($Form);
	//------------------------------------------------------------------------------
	if(!$HTTP.Send('/API/TicketMessageEdit',$Args)){
		//------------------------------------------------------------------------------
		alert('Не удалось отправить запрос на сервер');
		//------------------------------------------------------------------------------
		return false;
		//------------------------------------------------------------------------------
	}
	//------------------------------------------------------------------------------
	//------------------------------------------------------------------------------
	ShowProgress('Добавление сообщения в запрос');
	//------------------------------------------------------------------------------
	//------------------------------------------------------------------------------
}
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

